{% extends "base.html" %}

{% block title %}Configuraci√≥n{% endblock %}
{% block header %}Configuraci√≥n del Sistema{% endblock %}

{% block extra_css %}
<!-- GridStack.js CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack.min.css" />
<style>
    .grid-stack-item-content {
        background: rgba(7, 30, 38, 0.4);
        border: 1px solid var(--3f-border);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        overflow: hidden;
    }
    .grid-stack-item-content:hover {
        border-color: var(--3f-primary);
        box-shadow: 0 0 15px var(--3f-primary-glow);
    }
    .widget-header {
        padding: 8px 12px;
        background: rgba(37, 150, 190, 0.1);
        border-bottom: 1px solid var(--3f-border);
        font-family: 'Orbitron';
        font-size: 0.85rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: move; /* Drag handle cursor */
    }
</style>
{% endblock %}

{% block content %}
<div x-data="settingsPage" class="content-wrapper bg-transparent">
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h1 class="hud-title mb-0">
                    <i class="fa-solid fa-gears me-2 text-primary"></i>
                    <span x-text="$store.lang.t('settings.title') || 'CONFIGURACI√ìN_SISTEMA'"></span>
                </h1>
                <p class="text-dim small mb-0">PANEL DE CONTROL CENTRAL - NIVEL ADMINISTRADOR</p>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span id="layout-status" class="text-dim small"></span>
                <button @click="$store.settingsLayout.reset()" class="btn btn-sm btn-outline-secondary">
                    <i class="fa-solid fa-rotate-left me-1"></i>Restablecer Dise√±o
                </button>
            </div>
        </div>
    </div>

    <div class="grid-stack">
        
        <!-- Widget: General Settings (Full Width) -->
        <div class="grid-stack-item" gs-w="12" gs-h="6" gs-x="0" gs-y="0">
            <div class="grid-stack-item-content">
                <div class="widget-header">
                    <span><i class="fa-solid fa-sliders me-2 text-primary"></i>AJUSTES GENERALES</span>
                    <i class="fa-solid fa-grip-lines text-dim"></i>
                </div>
                <div class="p-3 h-100 overflow-auto">
                    <!-- ... tabs & form content preserved ... -->
                    <ul class="nav nav-tabs border-0 mb-3" id="settingsTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active text-primary fw-bold" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button">
                                GENERAL
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link text-accent fw-bold" id="themes-tab" data-bs-toggle="tab" data-bs-target="#themes" type="button">
                                <i class="fa-solid fa-palette me-1"></i>TEMAS
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link text-warning fw-bold" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button">
                                <i class="fa-solid fa-user-shield me-1"></i>PERFIL
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link text-info fw-bold" id="email-tab" data-bs-toggle="tab" data-bs-target="#email" type="button">
                                <i class="fa-solid fa-envelope me-1"></i><span x-text="$store.lang.t('settings.tab_email')">CORREO</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button @click="loadMaintenance()" class="nav-link text-secondary fw-bold" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance" type="button">
                                <i class="fa-solid fa-screwdriver-wrench me-1"></i><span x-text="$store.lang.t('settings.tab_maintenance')">MANTENIMIENTO</span>
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="settingsTabsContent">
                        <div class="tab-pane fade show active" id="general" role="tabpanel">
                            <form @submit.prevent="guardarConfig()">
                                <div class="mb-4">
                                    <h6 class="text-accent mb-3 border-bottom border-secondary border-opacity-25 pb-2">IDENTIDAD & FORMATO</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="text-dim small">NOMBRE_SISTEMA</label>
                                            <input type="text" class="form-control neon-input" x-model="config.SISTEMA_nombre">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="text-dim small">SIMBOLO_MONEDA</label>
                                            <input type="text" class="form-control neon-input text-center" x-model="config.SISTEMA_moneda">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="text-dim small">IDIOMA_DEFECTO</label>
                                            <select class="form-select neon-input" x-model="config.SISTEMA_idioma">
                                                <option value="es">Espa√±ol</option>
                                                <option value="en">English</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="text-dim small">SESSION_TIMEOUT</label>
                                            <select class="form-select neon-input" x-model="config.SISTEMA_timeout">
                                                <option value="0">Desactivado</option>
                                                <option value="5">5 Minutos</option>
                                                <option value="15">15 Minutos</option>
                                                <option value="30">30 Minutos</option>
                                                <option value="60">1 Hora</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <h6 class="text-warning mb-3 border-bottom border-secondary border-opacity-25 pb-2">AVANZADO</h6>
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="debugMode" x-model="config.DEBUG_mode">
                                        <label class="form-check-label text-dim" for="debugMode">MODO_DEPURACION (DEBUG)</label>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end mt-3">
                                    <button type="submit" class="btn btn-primary neon-btn" :disabled="saving">
                                        <span x-show="!saving">üíæ GUARDAR CAMBIOS</span>
                                        <span x-show="saving">‚è≥ Guardando...</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Themes Tab -->
                        <div class="tab-pane fade" id="themes" role="tabpanel">
                            <div x-data="themeSelector">
                                <h6 class="text-accent mb-3 border-bottom border-secondary border-opacity-25 pb-2">
                                    <i class="fa-solid fa-palette me-2"></i>SELECTOR DE TEMAS
                                </h6>
                                <p class="text-dim small mb-4">Elige tu tema visual preferido. Los cambios se aplican inmediatamente.</p>
                                
                                <div class="row g-3">
                                    <template x-for="theme in availableThemes" :key="theme.id">
                                        <div class="col-md-6 col-lg-3">
                                            <div 
                                                class="card h-100 cursor-pointer" 
                                                :class="currentThemeId === theme.id ? 'border-primary border-2' : 'border-secondary border-opacity-25'"
                                                @click="selectTheme(theme.id)"
                                                style="transition: all 0.2s;"
                                            >
                                                <div class="card-body p-3">
                                                    <h6 class="card-title mb-2" x-text="theme.name"></h6>
                                                    <p class="card-text small text-dim mb-2" x-text="theme.description"></p>
                                                    <div class="d-flex align-items-center gap-2 mt-3">
                                                        <span 
                                                            class="badge bg-primary" 
                                                            x-show="currentThemeId === theme.id"
                                                        >Activo</span>
                                                        <span 
                                                            class="badge bg-secondary" 
                                                            x-show="currentThemeId !== theme.id"
                                                        >Seleccionar</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                
                                <div x-show="loading" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="text-dim small mt-2">Cargando temas...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Profile Tab -->
                        <div class="tab-pane fade" id="profile" role="tabpanel">
                            <form @submit.prevent="saveProfile">
                                <h6 class="text-warning mb-3 border-bottom border-secondary border-opacity-25 pb-2">
                                    <i class="fa-solid fa-id-badge me-2"></i>DATOS DEL OPERADOR
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="text-dim small">NOMBRE</label>
                                        <input type="text" class="form-control neon-input" x-model="userProfile.nombre">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="text-dim small">APELLIDO</label>
                                        <input type="text" class="form-control neon-input" x-model="userProfile.apellido">
                                    </div>
                                    <div class="col-md-12">
                                        <label class="text-dim small">EMAIL DE ACCESO</label>
                                        <input type="email" class="form-control neon-input" x-model="userProfile.email">
                                    </div>
                                </div>
                                <div class="mt-4 text-end">
                                    <button type="submit" class="btn btn-warning neon-btn text-dark fw-bold" :disabled="saving">
                                        <i class="fa-solid fa-save me-2"></i>ACTUALIZAR PERFIL
                                    </button>
                                </div>
                            </form>

                            <hr class="border-secondary border-opacity-25 my-4">

                            <form @submit.prevent="changePassword">
                                <h6 class="text-danger mb-3 border-bottom border-secondary border-opacity-25 pb-2">
                                    <i class="fa-solid fa-key me-2"></i>CAMBIAR CONTRASE√ëA
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="text-dim small">CONTRASE√ëA ACTUAL</label>
                                        <input type="password" class="form-control neon-input" x-model="passwordForm.current_password">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="text-dim small">NUEVA CONTRASE√ëA</label>
                                        <input type="password" class="form-control neon-input" x-model="passwordForm.new_password">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="text-dim small">CONFIRMAR NUEVA CONTRASE√ëA</label>
                                        <input type="password" class="form-control neon-input" x-model="passwordForm.confirm_password">
                                    </div>
                                </div>
                                <div class="mt-4 text-end">
                                    <button type="submit" class="btn btn-outline-danger neon-btn fw-bold" :disabled="saving">
                                        <i class="fa-solid fa-lock me-2"></i>CAMBIAR CONTRASE√ëA
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Email Tab -->
                        <div class="tab-pane fade" id="email" role="tabpanel">
                            <form @submit.prevent="guardarSMTP()">
                                <h6 class="text-info mb-3 border-bottom border-secondary border-opacity-25 pb-2">
                                    <i class="fa-solid fa-envelope-open-text me-2"></i>CONFIGURACI√ìN SMTP
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-9">
                                        <label class="text-dim small" x-text="$store.lang.t('settings.smtp_host')">SERVIDOR_SMTP</label>
                                        <input type="text" class="form-control neon-input" x-model="config.SMTP_host" placeholder="smtp.ejemplo.com">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="text-dim small" x-text="$store.lang.t('settings.smtp_port')">PUERTO</label>
                                        <input type="number" class="form-control neon-input text-center" x-model="config.SMTP_port" placeholder="587">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="text-dim small" x-text="$store.lang.t('settings.smtp_user')">USUARIO_SMTP</label>
                                        <input type="text" class="form-control neon-input" x-model="config.SMTP_user">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="text-dim small" x-text="$store.lang.t('settings.smtp_pass')">CONTRASE√ëA_SMTP</label>
                                        <input type="password" class="form-control neon-input" x-model="config.SMTP_password">
                                    </div>
                                    <div class="col-md-12">
                                        <label class="text-dim small" x-text="$store.lang.t('settings.smtp_from')">REMITENTE (FROM)</label>
                                        <input type="email" class="form-control neon-input" x-model="config.SMTP_from" placeholder="noreply@tu-dominio.com">
                                    </div>
                                </div>
                                <div class="mt-4 d-flex justify-content-between">
                                    <button type="button" @click="testSMTP()" class="btn btn-outline-info neon-btn" :disabled="saving">
                                        <i class="fa-solid fa-paper-plane me-2"></i><span x-text="$store.lang.t('settings.smtp_test')">PROBAR ENV√çO</span>
                                    </button>
                                    <button type="submit" class="btn btn-info neon-btn text-dark fw-bold" :disabled="saving">
                                        <i class="fa-solid fa-save me-2"></i>GUARDAR SMTP
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Maintenance Tab -->
                        <div class="tab-pane fade" id="maintenance" role="tabpanel">
                            <div class="row g-4">
                                <div class="col-md-5">
                                    <h6 class="text-info mb-3 border-bottom border-secondary border-opacity-25 pb-2" x-text="$store.lang.t('settings.system_stats')">M√âTRICAS DEL SISTEMA</h6>
                                    <div class="bg-black bg-opacity-25 p-3 rounded border border-hud mb-3">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="text-dim smaller" x-text="$store.lang.t('settings.db_size')">TAMA√ëO BD</span>
                                            <span class="text-accent fw-bold" x-text="maintInfo.db_size + ' MB'"></span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="text-dim smaller" x-text="$store.lang.t('settings.file_count')">ATTACHMENTS</span>
                                            <span class="text-info fw-bold" x-text="maintInfo.file_count"></span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-dim smaller" x-text="$store.lang.t('settings.uptime')">UPTIME</span>
                                            <span class="text-success fw-bold">100.0%</span>
                                        </div>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary btn-sm text-start" @click="runBackup()" :disabled="processingMaint">
                                            <i class="fa-solid fa-download me-2"></i><span x-text="$store.lang.t('settings.backup_btn')">EJECUTAR BACKUP</span>
                                        </button>
                                        <button class="btn btn-outline-info btn-sm text-start" @click="runIntegrity()" :disabled="processingMaint">
                                            <i class="fa-solid fa-stethoscope me-2"></i><span x-text="$store.lang.t('settings.integrity_btn')">VERIFICAR BD</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <h6 class="text-accent mb-3 border-bottom border-secondary border-opacity-25 pb-2" x-text="$store.lang.t('settings.maintenance_terminal')">TERMINAL DE MANTENIMIENTO</h6>
                                    <div class="bg-black p-3 rounded border border-hud custom-scrollbar font-monospace" style="height: 200px; font-size: 0.75rem; overflow-y: auto;">
                                        <template x-for="log in maintLogs" :key="log.time">
                                            <div class="mb-1">
                                                <span class="text-dim">[<span x-text="log.time"></span>]</span>
                                                <span :class="log.type === 'error' ? 'text-danger' : (log.type === 'success' ? 'text-success' : 'text-info')" x-text="log.msg"></span>
                                            </div>
                                        </template>
                                        <div x-show="processingMaint" class="text-warning blink">_ EJECUTANDO_COMANDO...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="modules" role="tabpanel">
                            <div class="alert alert-info bg-opacity-10 border-info">
                                <i class="fa-solid fa-info-circle me-2"></i>
                                Gestionar en <a href="/plugins" class="text-info fw-bold">Plugins</a>.
                            </div>
                            <div class="list-group list-group-flush bg-transparent">
                                <template x-for="mod in modules" :key="mod.id">
                                    <div class="list-group-item bg-transparent border-secondary border-opacity-25 d-flex justify-content-between align-items-center px-0">
                                        <div>
                                            <i class="fa-solid fa-circle-check text-success me-2"></i>
                                            <span class="text-light" x-text="mod.name"></span>
                                        </div>
                                        <span class="badge bg-secondary bg-opacity-25 text-dim">INSTALADO</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget: System Info (Half Width) -->
        <div class="grid-stack-item" gs-w="6" gs-h="4" gs-x="0" gs-y="6">
            <div class="grid-stack-item-content">
                <div class="widget-header">
                    <span class="text-success"><i class="fa-solid fa-server me-2"></i>ESTADO DEL SISTEMA</span>
                    <i class="fa-solid fa-grip-lines text-dim"></i>
                </div>
                <div class="p-3">
                    <template x-if="systemInfo">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2 d-flex justify-content-between border-bottom border-secondary border-opacity-10 pb-1">
                                <span class="text-dim">Versi√≥n API</span>
                                <span class="text-white fw-bold" x-text="systemInfo.version"></span>
                            </li>
                            <li class="mb-2 d-flex justify-content-between border-bottom border-secondary border-opacity-10 pb-1">
                                <span class="text-dim">Estado</span>
                                <span class="badge bg-success text-dark">ONLINE</span>
                            </li>
                            <li class="mb-2 d-flex justify-content-between border-bottom border-secondary border-opacity-10 pb-1">
                                <span class="text-dim">Base de Datos</span>
                                <span class="text-white"><i class="fa-solid fa-database text-warning me-1"></i>Conectado</span>
                            </li>
                            <li class="d-flex justify-content-between">
                                <span class="text-dim">Entorno</span>
                                <span class="text-info">Producci√≥n</span>
                            </li>
                        </ul>
                    </template>
                    <div x-show="!systemInfo" class="text-center py-3">
                        <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget: Danger Zone (Half Width) -->
        <div class="grid-stack-item" gs-w="6" gs-h="4" gs-x="6" gs-y="6">
            <div class="grid-stack-item-content" style="border-color: var(--bs-danger); border-opacity: 0.3;">
                <div class="widget-header" style="background: rgba(220, 53, 69, 0.1);">
                    <span class="text-danger"><i class="fa-solid fa-triangle-exclamation me-2"></i>MANTENIMIENTO</span>
                    <i class="fa-solid fa-grip-lines text-dim"></i>
                </div>
                <div class="p-3">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-warning btn-sm text-start" @click="verificarIntegridad()">
                            <i class="fa-solid fa-stethoscope me-2"></i>Verificar Integridad BD
                        </button>
                        <button class="btn btn-outline-danger btn-sm text-start" disabled> 
                            <i class="fa-solid fa-trash-can me-2"></i>Limpiar Cach√©
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget: Localization Manager (Full Width) -->
        <div class="grid-stack-item" gs-w="12" gs-h="10" gs-x="0" gs-y="10">
            <div class="grid-stack-item-content" x-data="localizationManager">
                <div class="widget-header">
                    <span class="text-info"><i class="fa-solid fa-language me-2"></i>DICCIONARIO & LOCALIZACI√ìN</span>
                    <i class="fa-solid fa-grip-lines text-dim"></i>
                </div>
                <div class="p-3 h-100 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center gap-3">
                            <select class="form-select form-select-sm neon-input" style="width: 150px;" x-model="selectedLang" @change="loadTranslations()">
                                <template x-for="lang in availableLangs" :key="lang">
                                    <option :value="lang" x-text="lang.toUpperCase()"></option>
                                </template>
                            </select>
                            <div class="input-group input-group-sm" style="width: 250px;">
                                <span class="input-group-text bg-transparent border-secondary border-opacity-25 text-dim"><i class="fa-solid fa-search"></i></span>
                                <input type="text" class="form-control neon-input" placeholder="Filtrar claves..." x-model="searchQuery">
                            </div>
                        </div>
                        <button class="btn btn-sm btn-info neon-btn text-dark fw-bold" @click="saveTranslations()" :disabled="saving">
                            <i class="fa-solid fa-save me-1"></i>ACTUALIZAR DICCIONARIO
                        </button>
                    </div>

                    <!-- Nueva Clave Form -->
                    <div class="row g-2 mb-3 align-items-end p-2 border border-info border-opacity-10 rounded bg-black bg-opacity-25" x-show="!loading">
                        <div class="col-md-4">
                            <label class="form-label small text-dim mb-1" x-text="$store.lang.t('localization.col_key')"></label>
                            <input type="text" class="form-control form-control-sm neon-input" x-model="newKey.key" :placeholder="$store.lang.t('localization.add_key_placeholder')">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-dim mb-1" x-text="$store.lang.t('localization.col_value')"></label>
                            <input type="text" class="form-control form-control-sm neon-input" x-model="newKey.value" :placeholder="$store.lang.t('localization.add_value_placeholder')">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-sm btn-outline-info w-100" @click="addNewKey()" :disabled="!newKey.key || !newKey.value">
                                <i class="fa-solid fa-plus-circle me-1"></i>INSERTAR
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive flex-grow-1 custom-scrollbar" style="max-height: 500px; border: 1px solid rgba(255,255,255,0.05); border-radius: 4px;">
                        <table class="table table-sm table-dark table-hover mb-0" style="font-size: 0.85rem;">
                            <thead class="sticky-top bg-black">
                                <tr>
                                    <th style="width: 30%;" x-text="$store.lang.t('localization.col_key')">CLAVE (PATH)</th>
                                    <th style="width: 60%;" x-text="$store.lang.t('localization.col_value')">TRADUCCI√ìN / VALOR</th>
                                    <th style="width: 10%; text-align: center;">#</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(value, key) in filteredTranslations" :key="key">
                                    <tr>
                                        <td class="text-dim font-monospace small align-middle" x-text="key"></td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm border-0 border-bottom bg-transparent text-white rounded-0 px-1" x-model="flatTranslations[key]">
                                        </td>
                                        <td class="text-center align-middle">
                                            <button class="btn btn-link btn-sm text-danger p-0" @click="deleteKey(key)">
                                                <i class="fa-solid fa-trash-can"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div x-show="loading" class="text-center py-5">
                        <div class="spinner-border text-info" role="status"></div>
                        <p class="text-dim small mt-2" x-text="$store.lang.t('localization.loading')">Cargando diccionario neural...</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- GridStack JS -->
<script src="https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack-all.js"></script>

<script>
    let settingsGrid = null;
    let settingsLayoutManager = null;
    
    document.addEventListener('DOMContentLoaded', () => {
        // Inicializar GridStack despu√©s de que Alpine est√© listo
        setTimeout(() => {
            settingsGrid = GridStack.init({
                column: 12,
                cellHeight: 80,
                margin: 10,
                animate: true,
                draggable: { handle: '.widget-header' },
                float: true,
                disableOneColumnMode: false,
                staticGrid: false
            });
            
            // Initialize LayoutManager and load saved layout
            settingsLayoutManager = new LayoutManager('settings', settingsGrid);
            settingsLayoutManager.loadLayout();
        }, 100);
    });

    document.addEventListener('alpine:init', () => {
        // Store for layout management
        Alpine.store('settingsLayout', {
            reset: async () => {
                if (settingsLayoutManager) {
                    await settingsLayoutManager.resetLayout();
                }
            }
        });
        
        // Theme Selector Component
        Alpine.data('themeSelector', () => ({
            availableThemes: [],
            currentThemeId: null,
            loading: false,
            
            async init() {
                await this.loadThemes();
                await this.loadCurrentTheme();
            },
            
            async loadThemes() {
                this.loading = true;
                try {
                    const response = await api.get('/themes/presets');
                    this.availableThemes = response.data;
                } catch (error) {
                    console.error('Error loading themes:', error);
                } finally {
                    this.loading = false;
                }
            },
            
            async loadCurrentTheme() {
                try {
                    const response = await api.get('/themes/current');
                    this.currentThemeId = response.data.id;
                } catch (error) {
                    console.warn('Error loading current theme:', error);
                    this.currentThemeId = 'dark_neon';
                }
            },
            
            async selectTheme(themeId) {
                if (themeId === this.currentThemeId) return;
                
                try {
                    const success = await window.themeManager.switchTheme(themeId);
                    if (success) {
                        this.currentThemeId = themeId;
                    }
                } catch (error) {
                    console.error('Error switching theme:', error);
                    alert('Error al cambiar el tema');
                }
            }
        }));
        
        Alpine.data('settingsPage', () => ({
            config: {
                SISTEMA_nombre: 'Fer Futuro Forbes',
                SISTEMA_moneda: '$',
                SISTEMA_idioma: 'es',
                SISTEMA_timeout: 0,
                DEBUG_mode: false,
                SMTP_host: '',
                SMTP_port: 587,
                SMTP_user: '',
                SMTP_password: '',
                SMTP_from: ''
            },
            userProfile: {
                nombre: '',
                apellido: '',
                email: ''
            },
            passwordForm: {
                current_password: '',
                new_password: '',
                confirm_password: ''
            },
            maintInfo: { db_size: 0, file_count: 0 },
            maintLogs: [],
            processingMaint: false,
            systemInfo: null,
            modules: [
                { id: 1, name: 'Gestor de Presupuestos' },
                { id: 2, name: 'Transacciones Recurrentes' },
                { id: 3, name: 'Control de Activos' },
                { id: 4, name: 'Inversiones (Stocks)' },
                { id: 5, name: 'IA Forecasting' }
            ],
            saving: false,

            async init() {
                await this.loadConfig();
                await this.loadProfile();
                await this.checkSystem();
            },

            async loadProfile() {
                try {
                    const res = await api.get('auth/profile');
                    this.userProfile.nombre = res.data.nombre || '';
                    this.userProfile.apellido = res.data.apellido || '';
                    this.userProfile.email = res.data.email || '';
                } catch (e) {
                    console.warn('Profile not loaded:', e);
                }
            },

            async loadConfig() {
                try {
                    const res = await api.get('settings/');
                    res.data.forEach(item => {
                        if (item.clave === 'SISTEMA_nombre') this.config.SISTEMA_nombre = item.valor;
                        if (item.clave === 'SISTEMA_moneda') this.config.SISTEMA_moneda = item.valor;
                        if (item.clave === 'SISTEMA_idioma') this.config.SISTEMA_idioma = item.valor; 
                        if (item.clave === 'SISTEMA_timeout') this.config.SISTEMA_timeout = item.valor || 0;
                        if (item.clave === 'SMTP_host') this.config.SMTP_host = item.valor;
                        if (item.clave === 'SMTP_port') this.config.SMTP_port = item.valor;
                        if (item.clave === 'SMTP_user') this.config.SMTP_user = item.valor;
                        if (item.clave === 'SMTP_password') this.config.SMTP_password = item.valor;
                        if (item.clave === 'SMTP_from') this.config.SMTP_from = item.valor;
                    });
                     localStorage.setItem('3f_session_timeout', this.config.SISTEMA_timeout);
                } catch (e) {
                    console.warn('Config not fully loaded:', e);
                }
            },

            async checkSystem() {
                try {
                    const res = await axios.get('/api/estado');
                    this.systemInfo = {
                        version: '1.0.0', 
                        status: res.data.estado
                    };
                } catch (e) {
                    this.systemInfo = { version: 'Unknown', status: 'Offline' };
                }
            },

            async guardarConfig() {
                this.saving = true;
                try {
                    const keys = ['SISTEMA_nombre', 'SISTEMA_moneda', 'SISTEMA_idioma', 'SISTEMA_timeout']; 
                    for (const k of keys) {
                        await api.put(`settings/${k}`, { valor: this.config[k] });
                    }
                    localStorage.setItem('3f_session_timeout', this.config.SISTEMA_timeout);
                    
                    alert('Configuraci√≥n guardada correctamente.');
                    window.location.reload(); 
                } catch (e) {
                    alert('Error al guardar: ' + e.message);
                } finally {
                    this.saving = false;
                }
            },

            async guardarSMTP() {
                this.saving = true;
                try {
                    const keys = ['SMTP_host', 'SMTP_port', 'SMTP_user', 'SMTP_password', 'SMTP_from']; 
                    for (const k of keys) {
                        await api.put(`settings/${k}`, { valor: this.config[k] });
                    }
                    alert('Configuraci√≥n SMTP guardada correctamente.');
                } catch (e) {
                    alert('Error al guardar SMTP: ' + e.message);
                } finally {
                    this.saving = false;
                }
            },

            async testSMTP() {
                this.saving = true;
                try {
                    await api.post('health/test-mail', {
                        email: this.userProfile.email
                    });
                    alert('Correo de prueba enviado. Verifique su bandeja de entrada.');
                } catch (e) {
                    alert('Error en prueba SMTP: ' + (e.response?.data?.detail || e.message));
                } finally {
                    this.saving = false;
                }
            },

            async saveProfile() {
                this.saving = true;
                try {
                    await api.post('auth/profile', {
                        nombre: this.userProfile.nombre,
                        apellido: this.userProfile.apellido,
                        email: this.userProfile.email
                    });
                    alert('Perfil actualizado correctamente.');
                } catch (e) {
                    const msg = e.response?.data?.detail || 'Error al actualizar perfil';
                    alert(msg);
                } finally {
                    this.saving = false;
                }
            },

            async changePassword() {
                if (this.passwordForm.new_password !== this.passwordForm.confirm_password) {
                    alert('Las contrase√±as nuevas no coinciden');
                    return;
                }
                if (this.passwordForm.new_password.length < 6) {
                    alert('La nueva contrase√±a debe tener al menos 6 caracteres');
                    return;
                }
                this.saving = true;
                try {
                    await api.post('auth/change-password', {
                        current_password: this.passwordForm.current_password,
                        new_password: this.passwordForm.new_password
                    });
                    alert('Contrase√±a actualizada correctamente.');
                    this.passwordForm = { current_password: '', new_password: '', confirm_password: '' };
                } catch (e) {
                    const msg = e.response?.data?.detail || 'Error al cambiar contrase√±a';
                    alert(msg);
                } finally {
                    this.saving = false;
                }
            },

            async loadMaintenance() {
                try {
                    const res = await api.get('health');
                    this.maintInfo.db_size = res.data.checks.database_size_mb || 0;
                    this.maintInfo.file_count = res.data.checks.attachments_count || 0;
                } catch (e) {
                    console.error('Maint health failed', e);
                }
            },

            addMaintLog(msg, type = 'info') {
                const now = new Date().toLocaleTimeString();
                this.maintLogs.unshift({ time: now, msg, type });
            },

            async runBackup() {
                this.processingMaint = true;
                this.addMaintLog('Iniciando proceso de respaldo...', 'info');
                try {
                    const res = await api.post('health/backup');
                    this.addMaintLog(this.$store.lang.t('settings.backup_success') + ': ' + res.data.message, 'success');
                    notifications.show(this.$store.lang.t('settings.backup_success'), 'success');
                    await this.loadMaintenance();
                } catch (e) {
                    this.addMaintLog(this.$store.lang.t('settings.backup_failed'), 'error');
                } finally {
                    this.processingMaint = false;
                }
            },

            async runIntegrity() {
                this.processingMaint = true;
                this.addMaintLog('Analizando integridad de base de datos...', 'info');
                try {
                    const res = await api.post('health/integrity');
                    this.addMaintLog('Resultado Integridad: ' + res.data.report, res.data.status === 'success' ? 'success' : 'error');
                } catch (e) {
                    this.addMaintLog('Error en diagn√≥stico', 'error');
                } finally {
                    this.processingMaint = false;
                }
            },

            verificarIntegridad() {
                 this.runIntegrity();
            }
        }));

        // Localization Manager Component
        Alpine.data('localizationManager', () => ({
            availableLangs: [],
            selectedLang: localStorage.getItem('3f_lang') || 'es',
            translations: {},
            flatTranslations: {},
            searchQuery: '',
            loading: false,
            saving: false,
            newKey: { key: '', value: '' },

            async init() {
                await this.loadLangs();
                await this.loadTranslations();
            },

            async loadLangs() {
                try {
                    const res = await api.get('localization/languages');
                    this.availableLangs = res.data;
                } catch (e) {
                    this.availableLangs = ['es', 'en'];
                }
            },

            async loadTranslations() {
                this.loading = true;
                try {
                    const res = await api.get(`localization/${this.selectedLang}`);
                    this.translations = res.data;
                    this.flatTranslations = this.flattenObject(this.translations);
                } catch (e) {
                    console.error('Error loading translations:', e);
                } finally {
                    this.loading = false;
                }
            },

            get filteredTranslations() {
                const query = this.searchQuery.toLowerCase();
                const filtered = {};
                Object.keys(this.flatTranslations).forEach(key => {
                    if (key.toLowerCase().includes(query) || 
                        String(this.flatTranslations[key]).toLowerCase().includes(query)) {
                        filtered[key] = this.flatTranslations[key];
                    }
                });
                return filtered;
            },

            flattenObject(obj, prefix = '') {
                return Object.keys(obj).reduce((acc, k) => {
                    const pre = prefix.length ? prefix + '.' : '';
                    if (typeof obj[k] === 'object' && obj[k] !== null && !Array.isArray(obj[k])) {
                        Object.assign(acc, this.flattenObject(obj[k], pre + k));
                    } else {
                        acc[pre + k] = obj[k];
                    }
                    return acc;
                }, {});
            },

            unflattenObject(data) {
                const result = {};
                for (const i in data) {
                    const keys = i.split('.');
                    keys.reduce((r, e, j) => {
                        return r[e] || (r[e] = (keys.length - 1 === j ? data[i] : {}));
                    }, result);
                }
                return result;
            },

            addNewKey() {
                if (!this.newKey.key || !this.newKey.value) return;
                
                // Si la clave ya existe, avisar
                if (this.flatTranslations[this.newKey.key]) {
                    if (!confirm('La clave ya existe. ¬øDesea sobrescribirla?')) return;
                }
                
                this.flatTranslations[this.newKey.key] = this.newKey.value;
                this.newKey = { key: '', value: '' };
                notifications.show('Nueva palabra a√±adida al diccionario temporal. No olvide actualizar para guardar cambios permanentes.', 'info');
            },

            deleteKey(key) {
                if (confirm(`¬øEliminar la clave "${key}" del diccionario?`)) {
                    delete this.flatTranslations[key];
                }
            },

            async saveTranslations() {
                this.saving = true;
                try {
                    const nested = this.unflattenObject(this.flatTranslations);
                    await api.put(`localization/${this.selectedLang}`, nested);
                    
                    // Actualizar el store global de idioma para ver los cambios sin recargar
                    await Alpine.store('lang').loadLanguage(this.selectedLang);
                    
                    alert(`Diccionario (${this.selectedLang}) actualizado correctamente.`);
                } catch (e) {
                    alert('Error al guardar: ' + e.message);
                } finally {
                    this.saving = false;
                }
            }
        }));
    });
</script>
{% endblock %}
