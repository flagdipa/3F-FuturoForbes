{% extends "base.html" %}

{% block title %}<span x-text="$store.lang.t('nav.budgets')">Presupuestos</span>{% endblock %}
{% block header %}<span x-text="$store.lang.t('budgets.title')">Control Presupuestario</span>{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack.min.css" />
<style>
    .grid-stack-item-content {
        background: rgba(7, 30, 38, 0.4);
        border: 1px solid var(--3f-border);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        overflow: hidden;
        padding: 15px;
    }
    .neon-glow {
        box-shadow: 0 0 10px currentColor;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="budgetsPage" class="content-wrapper bg-transparent">
    <div class="row mb-4">
        <div class="col-12 mb-4 d-flex justify-content-between align-items-center">
            <button class="neon-btn px-4 py-2 shadow-sm" @click="nuevoPresupuesto()">
                <i class="fa-solid fa-plus-circle me-2"></i><span x-text="$store.lang.t('budgets.new')">DEFINIR LÍMITE</span>
            </button>
            <div class="d-flex align-items-center">
                <label class="text-dim me-2 small">AÑO:</label>
                <select class="form-select neon-input form-select-sm" style="width: 100px;" x-model="year" @change="loadBudgets()">
                    <template x-for="y in years" :key="y">
                        <option :value="y" x-text="y"></option>
                    </template>
                </select>
            </div>
        </div>
    </div>

    <!-- Grid de Presupuestos -->
    <div class="grid-stack">
        <template x-for="budget in presupuestos" :key="budget.id_presupuesto">
            <div class="grid-stack-item" gs-w="4" gs-h="5">
                <div class="grid-stack-item-content h-100 position-relative">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="text-primary mb-1 hud-title" x-text="budget.nombre_categoria || 'General'"></h5>
                            <span class="badge bg-dark border border-secondary text-dim extra-small" x-text="budget.periodo"></span>
                        </div>
                        <div class="text-end">
                            <h4 class="mb-0 text-white font-monospace" x-text="formatCurrency(budget.monto)"></h4>
                            <small class="text-dim extra-small fw-bold" x-text="$store.lang.t('budgets.col_limit')">LÍMITE</small>
                        </div>
                    </div>
                    
                    <!-- Barra de Progreso HUD -->
                    <div class="progress mb-2" style="height: 6px; background: rgba(255,255,255,0.1);">
                        <div class="progress-bar neon-glow" role="progressbar" 
                             :style="`width: ${getPorcentaje(budget)}%`"
                             :class="getColorBarra(budget)">
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between extra-small text-dim font-monospace text-uppercase">
                        <span x-text="$store.lang.t('budgets.col_spent') + ': ' + formatCurrency(budget.gasto_actual)"></span>
                        <div class="text-end">
                            <span x-text="(getPorcentaje(budget) || 0).toFixed(1) + '%'"></span>
                            <template x-if="budget.es_rolling">
                                <div class="text-info" style="font-size: 0.7em;" title="Rolling Accumulation">
                                    <i class="fa-solid fa-rotate-right me-1"></i>
                                    <span x-text="formatCurrency(budget.monto_acumulado)"></span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <button class="btn btn-sm btn-link text-dim position-absolute bottom-0 end-0 m-2" @click="editarPresupuesto(budget)">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                </div>
            </div>
        </template>
    </div>

    <!-- Modal de Edición/Creación -->
    <div class="modal fade" id="modalPresupuesto" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content neon-modal">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title hud-title text-primary"><i class="fa-solid fa-calculator me-2"></i> <span x-text="$store.lang.t('budgets.new')">CONFIG_PRESUPUESTO</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="guardarPresupuesto">
                        <div class="mb-3">
                            <label class="text-dim extra-small fw-bold text-uppercase" x-text="$store.lang.t('budgets.col_category')">CATEGORÍA OJETIVO</label>
                            <select class="form-select neon-input" x-model="form.id_categoria" required>
                                <option value="" disabled x-text="$store.lang.t('common.loading')">Seleccionar...</option>
                                <template x-for="cat in categorias" :key="cat.id_categoria">
                                    <option :value="cat.id_categoria" x-text="cat.nombre_categoria"></option>
                                </template>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="text-dim extra-small fw-bold text-uppercase" x-text="$store.lang.t('budgets.col_limit')">LÍMITE MENSUAL</label>
                            <input type="number" step="0.01" class="form-control neon-input" x-model="form.monto" required>
                        </div>
                        <div class="mb-3">
                            <label class="text-dim extra-small fw-bold text-uppercase" x-text="$store.lang.t('recurring.frequency')">PERIODO</label>
                            <select class="form-select neon-input" x-model="form.periodo">
                                <option value="Monthly" x-text="$store.lang.t('recurring.monthly')">Mensual</option>
                                <option value="Yearly" x-text="$store.lang.t('recurring.yearly')">Anual</option>
                                <option value="Weekly" x-text="$store.lang.t('recurring.weekly')">Semanal</option>
                            </select>
                        </div>
                        <div class="mb-3 form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="rollingCheck" x-model="form.es_rolling">
                            <label class="form-check-label text-white" for="rollingCheck">
                                <i class="fa-solid fa-rotate-right me-2 text-info"></i>Presupuesto Flexible (Rolling)
                            </label>
                            <div class="form-text text-dim small">
                                El saldo no utilizado se suma al siguiente periodo.
                            </div>
                        </div>
                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-outline-secondary px-4 me-2 border-opacity-10" data-bs-dismiss="modal" x-text="$store.lang.t('common.cancel')">CANCELAR</button>
                            <button type="submit" class="btn neon-btn px-4 shadow-sm" x-text="$store.lang.t('common.save')">CONFIRMAR_PARAMETROS</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack-all.js"></script>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('budgetsPage', () => ({
            presupuestos: [],
            categorias: [],
            form: { id_categoria: '', monto: 0, periodo: 'Monthly', es_rolling: false },
            modal: null,
            editingId: null,
            grid: null,
            layoutManager: null,
            year: new Date().getFullYear(),
            years: [],

            async init() {
                this.generateYears();
                this.modal = new bootstrap.Modal(document.getElementById('modalPresupuesto'));
                await Promise.all([this.loadBudgets(), this.loadCategories()]);
            },

            generateYears() {
                const current = new Date().getFullYear();
                for (let i = current; i >= current - 5; i--) {
                    this.years.push(i);
                }
            },

            async loadBudgets() {
                try {
                    const res = await api.get('/presupuestos', { params: { year: this.year } });
                    this.presupuestos = res.data;
                    
                    this.$nextTick(() => {
                        if (this.grid) {
                            this.grid.destroy(false);
                        }
                        this.grid = GridStack.init({
                            cellHeight: 70,
                            margin: 10,
                            column: 12,
                            disableOneColumnMode: false,
                            float: true
                        });
                    });
                } catch (e) {
                    console.error("Error loading budgets", e);
                }
            },

            async loadCategories() {
                try {
                    // Asumiendo que existe endpoint de categorias lista simple
                    const res = await api.get('/categorias'); 
                    // Si api/categorias devuelve tree, necesitariamos aplanarlo o usar otro endpoint.
                    // Por ahora asumimos que devuelve lista o tree y mostramos raiz. 
                    // Ajuste rápido: Si es tree, solo mostramos nivel 1 para MVP.
                    this.categorias = Array.isArray(res.data) ? res.data : []; 
                } catch (e) {
                    console.error("Error loading categories", e);
                }
            },

            nuevoPresupuesto() {
                this.editingId = null;
                this.form = { id_categoria: '', monto: 0, periodo: 'Monthly', es_rolling: false };
                this.modal.show();
            },

            editarPresupuesto(b) {
                this.editingId = b.id_presupuesto;
                this.form = { ...b };
                this.modal.show();
            },

            async guardarPresupuesto() {
                try {
                    let res;
                    if (this.editingId) {
                        res = await api.put(`/presupuestos/${this.editingId}`, this.form);
                    } else {
                        res = await api.post('/presupuestos/', this.form);
                    }
                    await this.loadBudgets();
                    this.modal.hide();
                } catch (e) {
                    alert('Error al guardar: ' + e.message);
                }
            },

            formatCurrency(val) {
                return CurrencyUtils.formatCurrency(val);
            },

            getPorcentaje(budget) {
                // Return real percentage calculated by backend
                return budget.porcentaje || 0;
            },

            getColorBarra(budget) {
                const p = this.getPorcentaje(budget);
                if (p > 100) return 'bg-danger'; // Over budget
                if (p > 90) return 'bg-warning'; // Warning zone
                return 'bg-success'; // Safe zone
            }
        }))
    });
</script>
{% endblock %}
