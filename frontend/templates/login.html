<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>3F | Iniciar Sesión</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Orbitron:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@4.0.0-beta2/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="/static/css/neon-3f.css">
</head>
<body class="login-page bg-body-tertiary">
    <canvas id="shader-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;"></canvas>
    
    <div class="login-box">
        <div class="login-logo mb-4">
            <a href="/" class="neon-glow fw-bold h1" style="font-family: 'Orbitron';">3F SYSTEM</a>
        </div>
        <div class="card neon-card">
            <div class="card-body login-card-body bg-transparent">
                <p class="login-box-msg text-dim">Ingrese sus credenciales para acceder al sistema</p>
                <form id="login-form">
                    <div class="input-group mb-3">
                        <input type="email" id="email" class="form-control bg-transparent border-primary text-white" placeholder="Email" required>
                        <div class="input-group-text border-primary bg-transparent text-primary">
                            <span class="fa-solid fa-envelope"></span>
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <input type="password" id="password" class="form-control bg-transparent border-primary text-white" placeholder="Contraseña" required>
                        <div class="input-group-text border-primary bg-transparent text-primary">
                            <span class="fa-solid fa-lock"></span>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary w-100 fw-bold neon-border">ACCEDER AL FUTURO</button>
                        </div>
                    </div>
                </form>
                <div class="mt-4 text-center">
                    <a href="/register" class="text-dim small">¿No tienes cuenta? Registrate aquí</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Shader Background Logic (Adapted from fondo.txt)
        const canvas = document.getElementById('shader-canvas');
        const gl = canvas.getContext('webgl');

        const vsSource = `
            attribute vec4 aVertexPosition;
            void main() { gl_Position = aVertexPosition; }
        `;

        const fsSource = `
            precision highp float;
            uniform vec2 iResolution;
            uniform float iTime;

            const float overallSpeed = 0.15;
            const float lineAmplitude = 0.8;
            const vec4 lineColor = vec4(0.145, 0.588, 0.745, 1.0); // Eastern Blue
            const int linesPerGroup = 12;

            float random(float t) {
                return (cos(t) + cos(t * 1.3 + 1.3) + cos(t * 1.4 + 1.4)) / 3.0;
            }

            void main() {
                vec2 uv = gl_FragCoord.xy / iResolution.xy;
                vec2 fragCoord = gl_FragCoord.xy;
                vec2 space = (fragCoord - iResolution.xy / 2.0) / iResolution.x * 2.0 * 5.0;

                float horizontalFade = 1.0 - (cos(uv.x * 6.28) * 0.5 + 0.5);
                float verticalFade = 1.0 - (cos(uv.y * 6.28) * 0.5 + 0.5);

                space.y += random(space.x * 0.5 + iTime * 0.2) * 1.0 * (0.5 + horizontalFade);
                space.x += random(space.y * 0.5 + iTime * 0.2 + 2.0) * 1.0 * horizontalFade;

                vec4 lines = vec4(0.0);
                vec4 bgColor1 = vec4(0.015, 0.058, 0.074, 1.0); // Base Dark
                vec4 bgColor2 = vec4(0.027, 0.117, 0.149, 1.0); // Lighter Dark

                for(int l = 0; l < 12; l++) {
                    float floatL = float(l);
                    float offsetTime = iTime * 0.25;
                    float offsetPosition = floatL + space.x * 0.5;
                    float rand = random(offsetPosition + offsetTime) * 0.5 + 0.5;
                    float halfWidth = mix(0.01, 0.15, rand * horizontalFade) / 2.0;
                    float offset = random(offsetPosition + offsetTime * (1.1 + floatL/12.0)) * mix(0.6, 2.0, horizontalFade);
                    
                    float linePos = random(space.x * 0.2 + iTime * 0.2) * horizontalFade * lineAmplitude + offset;
                    float dist = abs(linePos - space.y);
                    float lineEffect = smoothstep(halfWidth, 0.0, dist) / 2.0 + smoothstep(halfWidth * 0.15, 0.0, dist);
                    
                    lines += lineEffect * lineColor * rand;
                }

                gl_FragColor = mix(bgColor1, bgColor2, uv.y) * verticalFade + lines;
                gl_FragColor.a = 1.0;
            }
        `;

        function initShader() {
            const vs = gl.createShader(gl.VERTEX_SHADER);
            gl.shaderSource(vs, vsSource);
            gl.compileShader(vs);
            const fs = gl.createShader(gl.FRAGMENT_SHADER);
            gl.shaderSource(fs, fsSource);
            gl.compileShader(fs);
            const prog = gl.createProgram();
            gl.attachShader(prog, vs);
            gl.attachShader(prog, fs);
            gl.linkProgram(prog);
            return prog;
        }

        const program = initShader();
        const posLoc = gl.getAttribLocation(program, 'aVertexPosition');
        const resLoc = gl.getUniformLocation(program, 'iResolution');
        const timeLoc = gl.getUniformLocation(program, 'iTime');

        const buf = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, buf);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1, 1,1]), gl.STATIC_DRAW);

        function render(time) {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            gl.viewport(0, 0, canvas.width, canvas.height);
            gl.useProgram(program);
            gl.uniform2f(resLoc, canvas.width, canvas.height);
            gl.uniform1f(timeLoc, time * 0.001);
            gl.enableVertexAttribArray(posLoc);
            gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);
            gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
            requestAnimationFrame(render);
        }
        requestAnimationFrame(render);

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await axios.post('/api/auth/login', { email, password });
                localStorage.setItem('3f_token', response.data.access_token);
                window.location.href = '/';
            } catch (error) {
                alert('Error al iniciar sesión: ' + (error.response?.data?.detail || 'Error desconocido'));
            }
        });
    </script>
</body>
</html>
