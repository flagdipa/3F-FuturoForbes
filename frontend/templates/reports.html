{% extends "base.html" %}

{% block title %}Reportes Tácticos{% endblock %}
{% block header %}Inteligencia Financiera Avanzada{% endblock %}

{% block content %}
<div x-data="reportesPage" class="content-wrapper bg-transparent">
    <!-- Filtros y Acciones -->
    <div class="row mb-4">
        <div class="col-md-6 d-flex align-items-center">
            <div class="neon-card p-2 d-flex align-items-center me-3">
                <i class="fa-solid fa-calendar-alt text-primary me-2"></i>
                <select class="form-select bg-transparent border-0 text-white fw-bold" style="width: auto;" x-model="selectedYear" @change="fetchData">
                    <template x-for="year in years" :key="year">
                        <option :value="year" x-text="year"></option>
                    </template>
                </select>
            </div>
            <button class="btn neon-btn me-2" @click="downloadPDF" :disabled="loadingPDF">
                <i class="fa-solid fa-file-pdf me-2"></i>
                <span x-show="!loadingPDF">PDF</span>
                <span x-show="loadingPDF" class="spinner-border spinner-border-sm"></span>
            </button>
            <button class="btn neon-btn-outline" @click="downloadExcel" :disabled="loadingExcel">
                <i class="fa-solid fa-file-excel me-2"></i>
                <span x-show="!loadingExcel">EXCEL</span>
                <span x-show="loadingExcel" class="spinner-border spinner-border-sm"></span>
            </button>
        </div>
        <div class="col-md-6 text-end">
            <span class="text-dim small me-2">ESTADO DEL SISTEMA:</span>
            <span class="text-success fw-bold">ONLINE</span>
        </div>
    </div>

    <!-- KPIs -->
    <div class="row mb-4" id="kpi-row">
        <!-- Ingresos -->
        <div class="col-md-4 mb-3">
            <div class="neon-card p-3 position-relative overflow-hidden h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-dim small mb-1">
                            <i class="fa-solid fa-grip-vertical me-2 drag-handle text-secondary cursor-move" title="Arrastrar"></i>
                            INGRESOS ANUALES
                        </p>
                        <h3 class="text-white fw-bold mb-0" x-text="formatCurrency(totalIngresos)"></h3>
                    </div>
                    <div class="icon-circle bg-success bg-opacity-10 text-success">
                        <i class="fa-solid fa-arrow-trend-up"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- Gastos -->
        <div class="col-md-4 mb-3">
            <div class="neon-card p-3 position-relative overflow-hidden h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-dim small mb-1">
                            <i class="fa-solid fa-grip-vertical me-2 drag-handle text-secondary cursor-move" title="Arrastrar"></i>
                            GASTOS ANUALES
                        </p>
                        <h3 class="text-white fw-bold mb-0" x-text="formatCurrency(totalGastos)"></h3>
                    </div>
                    <div class="icon-circle bg-danger bg-opacity-10 text-danger">
                        <i class="fa-solid fa-arrow-trend-down"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- Balance -->
        <div class="col-md-4 mb-3">
            <div class="neon-card p-3 position-relative overflow-hidden h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-dim small mb-1">
                            <i class="fa-solid fa-grip-vertical me-2 drag-handle text-secondary cursor-move" title="Arrastrar"></i>
                            BALANCE NETO
                        </p>
                        <h3 class="fw-bold mb-0" 
                            :class="totalNeto >= 0 ? 'text-primary' : 'text-danger'"
                            x-text="formatCurrency(totalNeto)"></h3>
                    </div>
                    <div class="icon-circle bg-primary bg-opacity-10 text-primary">
                        <i class="fa-solid fa-scale-balanced"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row mb-4" id="charts-row">
        <!-- Evolución Mensual -->
        <div class="col-lg-8 mb-4">
            <div class="neon-card h-100">
                <h5 class="text-primary mb-4">
                    <i class="fa-solid fa-grip-vertical me-2 drag-handle text-secondary cursor-move" title="Arrastrar"></i>
                    <i class="fa-solid fa-chart-column me-2"></i>EVOLUCIÓN MENSUAL
                </h5>
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="evolutionChart"></canvas>
                </div>
            </div>
        </div>
        <!-- Categorías -->
        <div class="col-lg-4 mb-4">
            <div class="neon-card h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="text-primary mb-0">
                        <i class="fa-solid fa-grip-vertical me-2 drag-handle text-secondary cursor-move" title="Arrastrar"></i>
                        <i class="fa-solid fa-chart-pie me-2"></i>GASTOS POR CATEGORÍA
                    </h5>
                    <select class="form-select form-select-sm bg-dark text-white border-secondary w-auto" x-model="selectedMonth" @change="fetchCategories">
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="chart-container" style="position: relative; height: 300px; display: flex; justify-content: center;">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    <!-- Comparativa de Presupuesto -->
    <div class="row mb-4" id="budget-row">
        <div class="col-12">
            <div class="neon-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="text-primary mb-0">
                        <i class="fa-solid fa-scale-balanced me-2"></i>PRESUPUESTO VS. REALIDAD
                    </h5>
                    <span class="text-dim small" x-text="'Periodo: ' + selectedMonth + ' / ' + selectedYear"></span>
                </div>
                
                <div class="row">
                    <template x-for="item in budgetData" :key="item.categoria">
                        <div class="col-md-6 mb-4">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-white fw-bold" x-text="item.categoria"></span>
                                <span class="text-dim small" x-text="formatCurrency(item.real) + ' / ' + formatCurrency(item.presupuestado)"></span>
                            </div>
                            <div class="progress bg-dark" style="height: 10px;">
                                <div class="progress-bar" role="progressbar" 
                                     :style="'width: ' + Math.min(item.porcentaje, 100) + '%'"
                                     :class="item.porcentaje > 100 ? 'bg-danger shadow-danger' : (item.porcentaje > 80 ? 'bg-warning shadow-warning' : 'bg-success shadow-success')"
                                     :aria-valuenow="item.porcentaje" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <span class="extra-small" :class="item.porcentaje > 100 ? 'text-danger' : 'text-dim'" x-text="item.porcentaje + '% utilizado'"></span>
                                <span class="extra-small text-dim" x-text="'Dif: ' + formatCurrency(item.diferencia)"></span>
                            </div>
                        </div>
                    </template>
                    <template x-if="budgetData.length === 0">
                        <div class="col-12 text-center py-4">
                            <p class="text-dim">No hay presupuestos definidos para este periodo.</p>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('alpine:init', () => {
        // Variables locales para evitar que Alpine intente hacer reactivas las instancias de Chart.js
        let chartEvolucion = null;
        let chartCategoria = null;

        Alpine.data('reportesPage', () => ({
            years: [2024, 2025, 2026],
            selectedYear: 2026, // Default a 2026
            selectedMonth: new Date().getMonth() + 1,
            loadingPDF: false,
            loadingExcel: false,
            
            totalIngresos: 0,
            totalGastos: 0,
            totalNeto: 0,
            budgetData: [],
            
            async init() {
                // Esperar a que el DOM esté listo
                this.$nextTick(async () => {
                    try {
                        this.initCharts();
                        this.initDragAndDrop();
                        // Cargar datos una vez que todo lo visual está listo
                        await this.fetchData();
                    } catch (e) {
                        console.error("Error en inicialización:", e);
                    }
                });
            },

            initDragAndDrop() {
                const commonConfig = {
                    animation: 150,
                    ghostClass: 'opacity-50',
                    handle: '.drag-handle',
                    store: {
                        get: (sortable) => {
                            const order = localStorage.getItem(sortable.el.id);
                            return order ? order.split('|') : [];
                        },
                        set: (sortable) => {
                            const order = sortable.toArray();
                            localStorage.setItem(sortable.el.id, order.join('|'));
                        }
                    }
                };

                const kpiRow = document.getElementById('kpi-row');
                if (kpiRow) Sortable.create(kpiRow, { ...commonConfig, group: 'kpis' });
                
                const chartsRow = document.getElementById('charts-row');
                if (chartsRow) Sortable.create(chartsRow, { ...commonConfig, group: 'charts' });
            },

            async fetchData() {
                // Ejecutar en paralelo para velocidad
                await Promise.all([
                    this.fetchEvolution(), 
                    this.fetchCategories(),
                    this.fetchBudgetComparison()
                ]);
            },

            async fetchBudgetComparison() {
                try {
                    const res = await api.get(`/reportes/presupuesto-realidad?year=${this.selectedYear}&month=${this.selectedMonth}`);
                    this.budgetData = res.data;
                } catch (e) {
                    console.error("Error fetching budget comparison:", e);
                }
            },

            async fetchEvolution() {
                try {
                    const res = await api.get(`/reportes/mensual?year=${this.selectedYear}`);
                    const data = res.data;
                    
                    this.totalIngresos = data.ingresos.reduce((a, b) => a + b, 0);
                    this.totalGastos = data.gastos.reduce((a, b) => a + b, 0);
                    this.totalNeto = this.totalIngresos - this.totalGastos;
                    
                    this.updateEvolutionChart(data.labels, data.ingresos, data.gastos);
                } catch (e) {
                    console.error("Error fetching evolution:", e);
                }
            },

            async fetchCategories() {
                try {
                    const res = await api.get(`/reportes/categorias?month=${this.selectedMonth}&year=${this.selectedYear}`);
                    this.updateCategoryChart(res.data.labels, res.data.data);
                } catch (e) {
                    console.error("Error fetching categories:", e);
                }
            },

            async downloadPDF() {
                this.loadingPDF = true;
                try {
                    // Usar axios directamente para manejar el blob correctamente
                    const response = await axios({
                        url: '/api/export/transactions/pdf',
                        method: 'GET',
                        responseType: 'blob',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    
                    const url = window.URL.createObjectURL(new Blob([response.data]));
                    const link = document.createElement('a');
                    link.href = url;
                    link.setAttribute('download', `Reporte_Historial_${this.selectedYear}.pdf`);
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                } catch (e) {
                    console.error(e);
                    alert('ERROR AL GENERAR PDF: ' + e.message);
                } finally {
                    this.loadingPDF = false;
                }
            },

            async downloadExcel() {
                this.loadingExcel = true;
                try {
                    const response = await axios({
                        url: '/api/export/transactions/excel',
                        method: 'GET',
                        responseType: 'blob',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    
                    const url = window.URL.createObjectURL(new Blob([response.data]));
                    const link = document.createElement('a');
                    link.href = url;
                    link.setAttribute('download', `Exportacion_Transacciones_${this.selectedYear}.xlsx`);
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                } catch (e) {
                    console.error(e);
                    alert('ERROR AL GENERAR EXCEL: ' + e.message);
                } finally {
                    this.loadingExcel = false;
                }
            },

            initCharts() {
                Chart.defaults.color = '#8899a6';
                Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
                
                // Destruir instancias previas si existen
                if (chartEvolucion) chartEvolucion.destroy();
                if (chartCategoria) chartCategoria.destroy();

                const ctxEvo = document.getElementById('evolutionChart');
                if (ctxEvo) {
                    chartEvolucion = new Chart(ctxEvo.getContext('2d'), {
                        type: 'bar',
                        data: { labels: [], datasets: [] },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { labels: { color: '#fff' } } },
                            scales: {
                                y: { grid: { color: 'rgba(255, 255, 255, 0.05)' } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }

                const ctxCat = document.getElementById('categoryChart');
                if (ctxCat) {
                    chartCategoria = new Chart(ctxCat.getContext('2d'), {
                        type: 'doughnut',
                        data: { labels: [], datasets: [] },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } },
                            cutout: '70%'
                        }
                    });
                }
            },

            updateEvolutionChart(labels, ingresos, gastos) {
                if (!chartEvolucion) return;
                
                chartEvolucion.data.labels = labels;
                chartEvolucion.data.datasets = [
                    {
                        label: 'Ingresos',
                        data: ingresos,
                        backgroundColor: '#00f2ff', // Cyan Neón
                        borderRadius: 4
                    },
                    {
                        label: 'Gastos',
                        data: gastos,
                        backgroundColor: '#ff0055', // Magenta Neón
                        borderRadius: 4
                    }
                ];
                chartEvolucion.update();
            },

            updateCategoryChart(labels, data) {
                if (!chartCategoria) return;

                chartCategoria.data.labels = labels;
                chartCategoria.data.datasets = [{
                    data: data,
                    backgroundColor: [
                        '#00f2ff', '#7000ff', '#ff0055', '#ffe600', '#00ff9d',
                        '#ffffff', '#ff9900', '#ff00cc', '#00ccff', '#ccff00'
                    ],
                    borderWidth: 0,
                    hoverOffset: 10
                }];
                chartCategoria.update();
            },

            formatCurrency(val) {
                return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(val);
            }
        }));
    });
</script>
{% endblock %}
