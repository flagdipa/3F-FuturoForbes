{% extends "base.html" %}

{% block title %}Módulos{% endblock %}

{% block content %}
<div x-data="pluginsPage" class="content-wrapper bg-transparent">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="hud-title mb-0" x-text="$store.lang.t('plugins.title')">Centro de Control de Módulos HUD</h1>
                <p class="text-dim extra-small mb-0" x-text="$store.lang.t('plugins.subtitle')">Gestión avanzada de extensiones del sistema</p>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="btn-group neon-border p-1 bg-black">
                     <button class="btn btn-sm py-1 px-3" :class="view === 'installed' ? 'btn-primary' : 'text-dim'" @click="view = 'installed'">INSTALADOS</button>
                     <button class="btn btn-sm py-1 px-3" :class="view === 'marketplace' ? 'btn-primary' : 'text-dim'" @click="view = 'marketplace'">MARKETPLACE</button>
                </div>
                <div class="d-flex align-items-center">
                    <span class="text-dim extra-small fw-bold me-2" x-text="$store.lang.t('plugins.modular_system') + ' ' + $store.lang.t('plugins.status_core_ok')">SISTEMA MODULAR: NÚCLEO_OK</span>
                    <i class="fa-solid fa-microchip neon-glow text-primary"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Grid de Plugins Instalados -->
    <div class="row g-4" x-show="view === 'installed'" x-transition>
        <template x-for="p in plugins" :key="p.id_plugin">
            <div class="col-md-6 col-lg-4">
                <div class="card neon-card h-100 transition-all border-hud" :class="p.activo ? 'opacity-100' : 'opacity-75'">
                    <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-start pt-3">
                        <div>
                            <h5 class="mb-0 text-primary fw-bold font-orbitron" x-text="p.nombre_display"></h5>
                            <span class="extra-small text-dim font-orbitron" x-text="p.nombre_tecnico"></span>
                        </div>
                        <span class="badge rounded-pill" 
                              :class="p.activo ? 'bg-success bg-opacity-25 text-success border border-success' : 'bg-secondary bg-opacity-25 text-dim border border-secondary'"
                              x-text="p.activo ? $store.lang.t('plugins.active') : $store.lang.t('plugins.inactive')"></span>
                    </div>
                    <div class="card-body">
                        <p class="small text-white opacity-75" x-text="p.descripcion"></p>
                        <div class="d-flex flex-column gap-1 mt-3">
                            <div class="d-flex justify-content-between extra-small">
                                <span class="text-dim fw-bold" x-text="$store.lang.t('plugins.version')"></span>
                                <span class="text-primary fw-bold" x-text="p.version"></span>
                            </div>
                            <div class="d-flex justify-content-between extra-small">
                                <span class="text-dim fw-bold" x-text="$store.lang.t('plugins.author')"></span>
                                <span class="text-white bg-dark px-1" x-text="p.autor"></span>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-top border-secondary border-opacity-10 d-flex justify-content-between p-3">
                        <button class="btn btn-sm" 
                                :class="p.activo ? 'btn-outline-danger' : 'btn-outline-success border-success'"
                                @click="toggleEstado(p)"
                                :disabled="loading">
                            <i class="fa-solid me-1" :class="p.activo ? 'fa-power-off' : 'fa-play'"></i>
                            <span class="fw-bold" x-text="p.activo ? $store.lang.t('common.deactivate') : $store.lang.t('common.activate')"></span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary neon-border" @click="configurarPlugin(p)" :disabled="!p.activo">
                            <i class="fa-solid fa-gear me-1"></i>
                            <span class="fw-bold" x-text="$store.lang.t('plugins.configure')"></span>
                        </button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Marketplace Placeholder HUD -->
        <div class="col-md-6 col-lg-4" x-show="plugins.length === 0">
            <div class="card neon-card h-100 border-dashed border-secondary border-opacity-25 bg-black bg-opacity-40 d-flex align-items-center justify-content-center p-5 cursor-pointer" @click="view = 'marketplace'">
                <div class="text-center">
                    <i class="fa-solid fa-puzzle-piece fs-1 mb-3 text-dim"></i>
                    <h6 class="text-dim font-orbitron">No hay módulos instalados</h6>
                    <span class="extra-small text-dim text-uppercase fw-bold">Explorar Marketplace</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Grid de Marketplace -->
    <div class="row g-4" x-show="view === 'marketplace'" x-transition>
        <template x-for="m in availableModules" :key="m.nombre_tecnico">
            <div class="col-md-6 col-lg-4">
                <div class="card neon-card h-100 border-hud opacity-100 hover-glow">
                    <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-start pt-3">
                        <div>
                            <h5 class="mb-0 text-info fw-bold font-orbitron" x-text="m.nombre_display"></h5>
                            <span class="extra-small text-dim font-orbitron" x-text="m.nombre_tecnico"></span>
                        </div>
                        <span class="badge rounded-pill bg-info bg-opacity-25 text-info border border-info" x-text="m.precio === 0 ? 'FREE' : '$' + m.precio"></span>
                    </div>
                    <div class="card-body">
                        <p class="small text-white opacity-75" x-text="m.descripcion"></p>
                        <div class="extra-small text-dim mt-2">
                             <i class="fa-solid fa-tags me-1"></i> <span x-text="m.categoria"></span>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-top border-secondary border-opacity-10 p-3">
                        <button class="btn btn-sm btn-outline-info w-100 fw-bold" 
                                @click="instalarModulo(m)"
                                :disabled="loading || moduloYaInstalado(m.nombre_tecnico)">
                            <i class="fa-solid me-1" :class="moduloYaInstalado(m.nombre_tecnico) ? 'fa-check' : 'fa-download'"></i>
                            <span x-text="moduloYaInstalado(m.nombre_tecnico) ? 'INSTALADO' : 'INSTALAR AHORA'"></span>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Modal de Configuración HUD -->
    <div class="modal fade" id="modalConfigPlugin" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-black border-hud shadow-hud">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title font-orbitron text-primary">
                        <i class="fa-solid fa-sliders me-2"></i><span x-text="$store.lang.t('plugins.configuration_title')">CONFIGURACIÓN_MÓDULO</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" x-if="editPlugin">
                    <div class="p-2 mb-3 bg-primary bg-opacity-10 border-start border-primary border-4">
                         <h6 class="text-primary fw-bold mb-0 font-orbitron" x-text="editPlugin.nombre_display"></h6>
                         <small class="text-dim smaller" x-text="editPlugin.nombre_tecnico"></small>
                    </div>
                    
                    <!-- Dynamic Visual Editor (Phase 6.1) -->
                    <div class="mb-4">
                        <label class="text-primary extra-small fw-bold text-uppercase mb-3"><i class="fa-solid fa-microchip me-1"></i>Editor de Parámetros</label>
                        <div class="d-flex flex-column gap-3">
                            <template x-for="(value, key) in configObject" :key="key">
                                <div class="bg-dark bg-opacity-40 p-2 rounded border border-secondary border-opacity-10">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="extra-small text-dim fw-bold text-uppercase" x-text="key.replace('_', ' ')"></span>
                                        <span class="badge bg-secondary bg-opacity-10 text-dim smaller" x-text="typeof value"></span>
                                    </div>
                                    <template x-if="typeof value === 'boolean'">
                                        <div class="form-check form-switch m-0">
                                            <input class="form-check-input" type="checkbox" x-model="configObject[key]" @change="syncToRaw()">
                                        </div>
                                    </template>
                                    <template x-if="typeof value === 'number'">
                                        <input type="number" class="form-control form-control-sm bg-black border-secondary text-primary" 
                                               x-model.number="configObject[key]" @input="syncToRaw()">
                                    </template>
                                    <template x-if="typeof value === 'string'">
                                        <input type="text" class="form-control form-control-sm bg-black border-secondary text-white" 
                                               x-model="configObject[key]" @input="syncToRaw()">
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- JSON Editor (Collapsible) -->
                    <div class="mb-3">
                         <div class="d-flex justify-content-between align-items-center mb-2 cursor-pointer" @click="showRaw = !showRaw">
                             <label class="text-dim extra-small fw-bold text-uppercase mb-0">Vista Raw (BETA_DEBUG)</label>
                             <i class="fa-solid" :class="showRaw ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                         </div>
                         <div x-show="showRaw" x-collapse>
                             <textarea class="form-control bg-black border-secondary text-success font-monospace" 
                                       rows="6" style="font-size: 0.75rem;"
                                       x-model="configRaw" @input="syncToObject()"></textarea>
                         </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" x-text="$store.lang.t('common.cancel')"></button>
                    <button type="button" class="btn neon-btn" @click="guardarConfig()" :disabled="loading">
                        <span x-show="!loading" x-text="$store.lang.t('common.save')"></span>
                        <span x-show="loading" class="spinner-border spinner-border-sm"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('pluginsPage', () => ({
            plugins: [],
            loading: false,
            view: 'installed', // 'installed' or 'marketplace'
            showRaw: false,
            editPlugin: null,
            configRaw: '',
            configObject: {},
            bsModal: null,
            availableModules: [
                { 
                    nombre_tecnico: "ia_forecasting", nombre_display: "IA Forecasting", 
                    descripcion: "Proyecciones avanzadas basadas en ML.", 
                    version: "1.0.0", autor: "3F Core", precio: 0, categoria: "Financiero" 
                },
                { 
                    nombre_tecnico: "ia_ocr", nombre_display: "AI OCR Vision", 
                    descripcion: "Reconocimiento de facturas por fotos.", 
                    version: "1.0.2", autor: "3F Core", precio: 0, categoria: "Herramientas" 
                },
                { 
                    nombre_tecnico: "gmail_connector", nombre_display: "Gmail Bridge", 
                    descripcion: "Sincroniza transacciones desde tu correo.", 
                    version: "0.9.0", autor: "3F Labs", precio: 5, categoria: "Conectores" 
                },
                { 
                    nombre_tecnico: "crypto_tracker", nombre_display: "Crypto Live", 
                    descripcion: "Precios en tiempo real de Binance/Kraken.", 
                    version: "1.2.0", autor: "3F Labs", precio: 0, categoria: "Inversiones" 
                }
            ],

            async init() {
                const modalEl = document.getElementById('modalConfigPlugin');
                if (modalEl) this.bsModal = new bootstrap.Modal(modalEl);
                await this.cargarPlugins();
            },

            async cargarPlugins() {
                this.loading = true;
                try {
                    const res = await api.get('/plugins/');
                    this.plugins = res.data;
                } catch (e) {
                    console.error('Error cargando plugins:', e);
                } finally {
                    this.loading = false;
                }
            },

            moduloYaInstalado(nombre) {
                return this.plugins.some(p => p.nombre_tecnico === nombre);
            },

            async instalarModulo(m) {
                this.loading = true;
                try {
                    const res = await api.post('/plugins/', {
                        nombre_tecnico: m.nombre_tecnico,
                        nombre_display: m.nombre_display,
                        descripcion: m.descripcion,
                        version: m.version,
                        autor: m.autor,
                        configuracion: {}
                    });
                    this.plugins.push(res.data);
                    notifications.show('Módulo instalado con éxito', 'success');
                    this.view = 'installed';
                } catch (e) {
                    notifications.show('Error al instalar módulo', 'error');
                } finally {
                    this.loading = false;
                }
            },

            async toggleEstado(p) {
                this.loading = true;
                try {
                    const res = await api.patch(`/plugins/${p.id_plugin}`, { activo: !p.activo });
                    const idx = this.plugins.findIndex(pl => pl.id_plugin === p.id_plugin);
                    if (idx !== -1) {
                        this.plugins[idx] = res.data;
                    }
                    notifications.show(res.data.activo ? 'Módulo Activado' : 'Módulo Desactivado', 'success');
                } catch (e) {
                    notifications.show('Error al cambiar estado', 'error');
                } finally {
                    this.loading = false;
                }
            },

            configurarPlugin(p) {
                this.editPlugin = p;
                this.configObject = JSON.parse(JSON.stringify(p.configuracion || {}));
                this.configRaw = JSON.stringify(this.configObject, null, 4);
                this.showRaw = false;
                if (this.bsModal) this.bsModal.show();
            },

            syncToRaw() {
                this.configRaw = JSON.stringify(this.configObject, null, 4);
            },

            syncToObject() {
                try {
                    this.configObject = JSON.parse(this.configRaw);
                } catch (e) {
                    // Invalid JSON
                }
            },

            async guardarConfig() {
                this.loading = true;
                try {
                    const res = await api.patch(`/plugins/${this.editPlugin.id_plugin}`, { 
                        configuracion: this.configObject 
                    });
                    const idx = this.plugins.findIndex(pl => pl.id_plugin === this.editPlugin.id_plugin);
                    if (idx !== -1) {
                        this.plugins[idx] = res.data;
                    }
                    notifications.show('Configuración guardada', 'success');
                    if (this.bsModal) this.bsModal.hide();
                } catch (e) {
                    notifications.show('Error al guardar configuración', 'error');
                } finally {
                    this.loading = false;
                }
            }
        }));
    });
</script>
{% endblock %}
