{% extends "base.html" %}

{% block title %}Control Central{% endblock %}
{% block header %}Control Central HUD{% endblock %}

{% block extra_css %}
<!-- GridStack.js CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack.min.css" />
<style>
    .grid-stack-item-content {
        background: rgba(7, 30, 38, 0.4);
        border: 1px solid var(--3f-border);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        overflow: hidden;
    }
    .grid-stack-item-content:hover {
        border-color: var(--3f-primary);
        box-shadow: 0 0 15px var(--3f-primary-glow);
    }
    .widget-header {
        padding: 5px 10px;
        background: rgba(37, 150, 190, 0.1);
        border-bottom: 1px solid var(--3f-border);
        font-family: 'Orbitron';
        font-size: 0.8rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .currency-hud-selector {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(0, 242, 255, 0.3);
        transition: all 0.3s ease;
    }
    .currency-hud-selector:hover {
        border-color: #00f2ff;
        box-shadow: 0 0 10px rgba(0, 242, 255, 0.2);
    }
    .hud-title {
        font-family: 'Orbitron', sans-serif;
        letter-spacing: 2px;
        color: #00f2ff;
        text-shadow: 0 0 15px rgba(0, 242, 255, 0.5);
    }
</style>
{% endblock %}

{% block content %}
<div x-data="dashboardWidgets">
<div class="scanline"></div>

<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center flex-wrap">
        <h4 class="neon-glow mb-2 mb-md-0"><i class="fa-solid fa-microchip me-2"></i><span x-text="$store.lang.t('dashboard.system_status')">ESTADO DEL SISTEMA</span></h4>
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <span class="text-dim small">Sincrotemporal: <span x-text="fechaActual"></span></span>
            <button @click="updateDashboard(true)" class="btn btn-sm btn-outline-primary neon-border">
                <i class="fa-solid fa-sync"></i> <span x-text="$store.lang.t('dashboard.refresh')">REFRESCAR_DATA</span>
            </button>
           
            <!-- Layout Status Indicator -->
            <span id="layout-status" class="text-dim small"></span>
        </div>
    </div>
</div>

<!-- Reset Layout Button (Right below header) -->
<div class="row mb-3">
    <div class="col-12 d-flex justify-content-end">
        <button @click="resetLayout()" class="btn btn-sm btn-outline-secondary">
            <i class="fa-solid fa-rotate-left me-1"></i>Restablecer Dise√±o
        </button>
    </div>
</div>

<!-- Grid Principal -->
<div class="grid-stack">
    <!-- Row 1: KPIs & Summary -->
    
    <!-- Widget: Patrimonio Neto (Top Left) -->
    <div class="grid-stack-item" gs-w="4" gs-h="7" gs-x="0" gs-y="0">
        <div class="grid-stack-item-content">
            <div class="widget-header">
                <span x-text="$store.lang.t('dashboard.net_worth')">PATRIMONIO_NETO</span>
                <i @click="showBreakdown = !showBreakdown" class="fa-solid fa-circle-info text-primary cursor-pointer" title="Ver desglose"></i>
            </div>
            
            <div class="p-4 text-center">
                <!-- Mini Savings Ratio Indicator (New Phase 11) -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-dim smaller">RATIO_AHORRO_MENSUAL</small>
                        <span class="badge rounded-pill" :class="savingsRate.status === 'HEALTHY' ? 'bg-success bg-opacity-25 text-success' : 'bg-warning bg-opacity-25 text-warning'" x-text="savingsRate.savings_rate_percentage + '%'">0%</span>
                    </div>
                    <div class="progress bg-dark" style="height: 4px;">
                        <div class="progress-bar" role="progressbar" :style="'width: ' + Math.min(Math.max(savingsRate.savings_rate_percentage || 0, 0), 100) + '%;'" :class="savingsRate.status === 'HEALTHY' ? 'bg-success' : 'bg-warning'"></div>
                    </div>
                </div>

                <h2 class="neon-glow mb-0" x-text="formatCurrency(resumen.patrimonio_neto)">$0.00</h2>
                <small class="text-dim" x-text="$store.lang.t('dashboard.net_worth_total')">TOTAL CONSOLIDADO (ARS)</small>
                
                <div class="hud-line"></div>
                
                <!-- Detailed Breakdown -->
                <div class="mt-3 text-start px-2">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small text-dim">L√≠quido</span>
                        <span class="small fw-bold" x-text="formatCurrency(resumen.total_liquido)"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small text-dim">Activos</span>
                        <span class="small fw-bold" x-text="formatCurrency(resumen.total_activos)"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small text-dim">Inversiones</span>
                        <span class="small fw-bold" x-text="formatCurrency(resumen.total_inversiones)"></span>
                    </div>
                </div>

                <div class="row mt-2 border-top border-secondary border-opacity-25 pt-2">
                    <div class="col-6 border-end border-secondary">
                        <small class="d-block text-success" x-text="$store.lang.t('dashboard.incomes')">INGRESOS (MES)</small>
                        <span class="fw-bold" x-text="formatCurrency(resumen.ingresos_mes)">+ $0.00</span>
                    </div>
                    <div class="col-6">
                        <small class="d-block text-danger" x-text="$store.lang.t('dashboard.expenses')">GASTOS (MES)</small>
                        <span class="fw-bold" x-text="formatCurrency(resumen.gastos_mes)">- $0.00</span>
                    </div>
                </div>

                <div class="mt-3 p-2 bg-dark-subtle rounded border border-info border-opacity-25">
                    <small class="text-info d-block" x-text="$store.lang.t('dashboard.projected_30d')">PROYECCION 30 DIAS</small>
                    <h4 class="mb-0 text-info" x-text="formatCurrency(resumen.proyeccion_30d)">$0.00</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Widget: Distribuci√≥n por Categor√≠as (Top Center) -->
    <div class="grid-stack-item" gs-w="4" gs-h="4" gs-x="4" gs-y="0">
        <div class="grid-stack-item-content">
            <div class="widget-header">
                <span x-text="$store.lang.t('dashboard.expense_distribution')">DISTRIBUCION_GASTOS</span>
                <i class="fa-solid fa-chart-pie text-secondary"></i>
            </div>
            <div class="p-3">
                <canvas id="chart-categorias" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Widget: Inversiones (Top Right - Moved Up) -->
    <div class="grid-stack-item" gs-w="4" gs-h="4" gs-x="8" gs-y="0">
        <div class="grid-stack-item-content">
            <div class="widget-header">
                <span x-text="$store.lang.t('dashboard.portfolio')">PORTAFOLIO_INVERSIONES</span>
                <i class="fa-solid fa-arrow-trend-up text-info"></i>
            </div>
            <div class="p-4">
                <div class="text-center mb-3">
                    <small class="text-dim d-block mb-1">VALOR TOTAL DE MERCADO</small>
                    <h3 class="mb-0 fw-bold" :class="summary.total_profit_loss >= 0 ? 'text-success' : 'text-danger'" x-text="formatCurrency(summary.current_value)">$0.00</h3>
                </div>
                <div class="d-flex justify-content-between align-items-center border-top border-secondary border-opacity-25 pt-3">
                    <div class="text-start">
                        <small class="text-dim d-block">Invertido</small>
                        <span class="fw-bold text-light" x-text="formatCurrency(summary.total_invested)"></span>
                    </div>
                    <div class="text-end">
                        <span class="badge rounded-pill mb-1" :class="summary.profit_loss_percentage >= 0 ? 'bg-success' : 'bg-danger'">
                            <i class="fa-solid me-1" :class="summary.profit_loss_percentage >= 0 ? 'fa-caret-up' : 'fa-caret-down'"></i>
                            <span x-text="(summary.profit_loss_percentage || 0).toFixed(2)">0.00</span>%
                        </span>
                        <div class="small text-dim" x-text="formatCurrency(summary.total_profit_loss)"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Analysis & Log -->

    <!-- Widget: Evoluci√≥n de Flujo (Bottom Left - Wide) -->
    <div class="grid-stack-item" gs-w="8" gs-h="5" gs-x="0" gs-y="4">
        <div class="grid-stack-item-content">
            <div class="widget-header">
                <div>
                    <span x-text="$store.lang.t('dashboard.flow_evolution') || 'EVOLUCION_FLUJO'">EVOLUCION_FLUJO</span>
                    <span x-show="aiEnabled" class="badge bg-primary ms-2 neon-border" style="font-size: 0.6rem; vertical-align: middle;">
                        <i class="fa-solid fa-robot"></i> AI POWERED
                    </span>
                </div>
                <i class="fa-solid fa-chart-line text-primary"></i>
            </div>
            <div class="p-3">
                <canvas id="chart-evolucion" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Widget: Inteligencia Patrimonial (New in Phase 11) -->
    <div class="grid-stack-item" gs-w="12" gs-h="5" gs-x="0" gs-y="14">
        <div class="grid-stack-item-content border-info border-opacity-50">
            <div class="widget-header bg-info bg-opacity-10 border-info border-opacity-25">
                <div class="d-flex align-items-center">
                    <span class="text-info fw-bold">EVOLUCION_PATRIMONIAL_HISTORICA</span>
                    <span class="badge bg-info bg-opacity-25 text-info ms-2 border border-info border-opacity-25" style="font-size: 0.6rem;">HUD_SNAPSHOTS</span>
                </div>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm bg-dark text-dim border-secondary p-0 px-2" style="font-size: 0.7rem; width: 80px;" x-model="wealthHistoryDays" @change="updateWealthChart()">
                        <option value="7">7D</option>
                        <option value="30" selected>30D</option>
                        <option value="90">90D</option>
                    </select>
                    <i class="fa-solid fa-chart-area text-info"></i>
                </div>
            </div>
            <div class="p-3">
                <canvas id="chart-patrimonio-hist" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Widget: Asignaci√≥n de Activos (New in Phase 7) -->
    <div class="grid-stack-item" gs-w="4" gs-h="5" gs-x="0" gs-y="9">
        <div class="grid-stack-item-content">
            <div class="widget-header">
                <span>ASIGNACION_ACTIVOS</span>
                <i class="fa-solid fa-layer-group text-info"></i>
            </div>
            <div class="p-3">
                <canvas id="chart-asignacion" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Widget: Actividad Reciente (Moved to accommodate new widget) -->
    <div class="grid-stack-item" gs-w="8" gs-h="5" gs-x="4" gs-y="9">
        <div class="grid-stack-item-content">
            <div class="widget-header">
                <span x-text="$store.lang.t('dashboard.recent_activity') || 'ACTIVIDAD RECIENTE'">ACTIVIDAD RECIENTE</span>
                <i class="fa-solid fa-clock-rotate-left text-primary"></i>
            </div>
            <div class="p-2">
                <div class="table-responsive h-100">
                    <table class="table table-sm table-borderless text-white mb-0">
                        <tbody style="font-family: 'Consolas', monospace; font-size: 0.8rem;">
                            <template x-for="tx in transactions" :key="tx.id_transaccion">
                                <tr class="border-bottom border-light border-opacity-10 align-middle">
                                    <td width="30" class="text-center">
                                        <i class="fa-solid" :class="tx.codigo_transaccion === 'Deposit' ? 'fa-circle-chevron-up text-success' : 'fa-circle-chevron-down text-danger'"></i>
                                    </td>
                                    <td>
                                        <div class="fw-bold text-truncate" style="max-width: 120px;" x-text="tx.nombre_beneficiario"></div>
                                        <div class="small text-dim" x-text="tx.nombre_categoria"></div>
                                    </td>
                                    <td class="text-end fw-bold" :class="tx.codigo_transaccion === 'Deposit' ? 'text-success' : 'text-danger'">
                                        <span x-text="(tx.codigo_transaccion === 'Deposit' ? '+' : '-') + formatCurrency(tx.monto_transaccion)"></span>
                                    </td>
                                </tr>
                            </template>
                            <template x-if="transactions.length === 0">
                                <tr>
                                    <td colspan="3" class="text-center p-4 text-dim">No hay actividad reciente</td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack-all.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('alpine:init', () => {
        // Defensive check for API client
        const getApiClient = () => window.api || { get: () => Promise.resolve({data:[]}), post: () => Promise.resolve({data:[]}) };

        // Global utility for formatting
        window.formatCurrencyGlobal = function(amount, currency = 'ARS') {
            const symbols = { 'ARS': '$', 'USD_BLUE': 'US$', 'BTC': '‚Çø', 'ETH': 'Œû' };
            const prefix = symbols[currency] || '$';
            let val = amount || 0;
            if (currency === 'BTC' || currency === 'ETH') {
                val = parseFloat(val).toFixed(6);
            } else {
                val = parseFloat(val).toLocaleString('es-AR', { minimumFractionDigits: 2 });
            }
            return `${prefix} ${val}`;
        };

        Alpine.data('dashboardWidgets', () => ({
            fechaActual: new Date().toLocaleString(),
            selectedCurrency: localStorage.getItem('3f_pref_currency') || 'ARS',
            showBreakdown: false,
            resumen: { 
                patrimonio_neto: 0, total_liquido: 0, total_activos: 0, total_inversiones: 0, 
                ingresos_mes: 0, gastos_mes: 0, proyeccion_30d: 0 
            },
            summary: { total_invested: 0, current_value: 0, total_profit_loss: 0, profit_loss_percentage: 0 },
            transactions: [],
            aiEnabled: false,
            wealthHistoryDays: 30,
            savingsRate: { savings_rate_percentage: 0, status: 'AVERAGE' },
            grid: null,
            layoutManager: null,
            charts: { categorias: null, evolucion: null, asignacion: null, patrimonioHist: null },

            async init() {
                console.log("üöÄ Dashboard Widgets Init (Consolidated) - Starting...");
                
                // Clock synchronization
                setInterval(() => { this.fechaActual = new Date().toLocaleString(); }, 1000);

                // 1. GridStack & Layout
                this.$nextTick(() => {
                    try {
                        this.grid = GridStack.init({
                            cellHeight: 70, margin: 10, column: 12,
                            disableOneColumnMode: false, float: true,
                            draggable: { handle: '.widget-header' }
                        });
                        
                        if (window.LayoutManager) {
                            this.layoutManager = new LayoutManager('dashboard', this.grid);
                            this.layoutManager.loadLayout();
                        }
                    } catch (e) { console.error("Grid/Layout Error:", e); }
                });
                
                // 2. Initial Data
                await this.updateDashboard();
                
                // Listen for refresh events
                window.addEventListener('update-data', () => this.updateDashboard(true));
                console.log("‚úÖ Dashboard Widgets Init (Consolidated) - Complete");
            },
            
            async updateDashboard(force = false) {
                console.log("üîÑ Updating Dashboard Data...");
                try {
                    await Promise.all([
                        this.loadResumen(),
                        this.loadSummary(),
                        this.loadTransactions(),
                        this.loadSavingsRate()
                    ]);
                    
                    if (!this.charts.categorias || force) {
                        this.initCharts();
                    } else {
                        this.updateCharts();
                    }
                } catch (e) { console.error("Update Error:", e); }
            },
            
            async resetLayout() {
                if (this.layoutManager) await this.layoutManager.resetLayout();
            },

            formatCurrency(amount) {
                return window.formatCurrencyGlobal(amount, this.selectedCurrency);
            },

            async loadResumen() {
                try {
                    const currency = this.selectedCurrency || 'ARS';
                    localStorage.setItem('3f_pref_currency', currency);
                    const res = await getApiClient().get(`/resumen/?currency=${currency}`);
                    this.resumen = res.data;
                } catch (e) { console.error('loadResumen fail', e); }
            },

            async loadSummary() {
                try {
                    const res = await getApiClient().get('/stocks/summary');
                    if(res.data) this.summary = res.data;
                } catch (e) { console.warn('stocks summary empty'); }
            },

            async loadTransactions() {
                try {
                    const res = await getApiClient().get('/transacciones/?limit=5');
                    this.transactions = res.data;
                } catch (e) { console.error('loadTransactions fail', e); }
            },

            async loadSavingsRate() {
                try {
                    const res = await getApiClient().get('/wealth/savings-rate');
                    if(res.data) this.savingsRate = res.data;
                } catch (e) { console.error('loadSavingsRate fail', e); }
            },

            initCharts() {
                console.log("üìä Initializing Charts...");
                const ctxCat = document.getElementById('chart-categorias');
                const ctxEvo = document.getElementById('chart-evolucion');
                const ctxWealth = document.getElementById('chart-patrimonio-hist');
                const ctxAsign = document.getElementById('chart-asignacion');

                Object.values(this.charts).forEach(c => { if(c) c.destroy(); });

                if (ctxCat) {
                    this.charts.categorias = new Chart(ctxCat.getContext('2d'), {
                        type: 'doughnut',
                        data: { labels: [], datasets: [{ data: [], backgroundColor: ['#2596be', '#6c25be', '#96be25', '#bea925', '#be4d25', '#be2596'], borderColor: '#040f13', borderWidth: 2 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#ffffff', font: { size: 10, family: 'Orbitron' } } } } }
                    });
                }

                if (ctxEvo) {
                    this.charts.evolucion = new Chart(ctxEvo.getContext('2d'), {
                        type: 'line',
                        data: { labels: [], datasets: [{ label: 'REAL', data: [], borderColor: '#2596be', backgroundColor: 'rgba(37, 150, 190, 0.1)', fill: true, tension: 0.4 }, { label: 'PROYECCION', data: [], borderColor: '#2596be', borderDash: [5, 5], backgroundColor: 'transparent', fill: false, tension: 0.4 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#ffffff' } } }, scales: { y: { grid: { color: 'rgba(37, 150, 190, 0.05)' }, ticks: { color: '#bee0ec' } }, x: { grid: { display: false }, ticks: { color: '#bee0ec' } } } }
                    });
                }

                if (ctxWealth) {
                    this.charts.patrimonioHist = new Chart(ctxWealth.getContext('2d'), {
                        type: 'line',
                        data: { labels: [], datasets: [] },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(0, 0, 0, 0.8)', bodyFont: { family: 'Consolas' }, callbacks: { label: (context) => this.formatCurrency(context.raw) } } },
                            scales: { y: { grid: { color: 'rgba(0, 242, 255, 0.05)' }, ticks: { color: '#00f2ff', font: { size: 9 } } }, x: { grid: { display: false }, ticks: { color: '#00f2ff', font: { size: 9 } } } }
                        }
                    });
                }

                if (ctxAsign) {
                    this.charts.asignacion = new Chart(ctxAsign.getContext('2d'), {
                        type: 'doughnut',
                        data: { labels: ['L√≠quido', 'Activos', 'Inversiones'], datasets: [{ data: [0, 0, 0], backgroundColor: ['#00f2ff', '#7000ff', '#be2596'], borderColor: '#040f13', borderWidth: 2 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#ffffff', font: { size: 10, family: 'Orbitron' } } } } }
                    });
                }
                this.updateCharts();
            },

            async updateCharts() {
                try {
                    const api = getApiClient();
                    if (this.charts.categorias) {
                        const resCat = await api.get('/reportes/categorias');
                        this.charts.categorias.data.labels = resCat.data.labels;
                        this.charts.categorias.data.datasets[0].data = resCat.data.data;
                        this.charts.categorias.update();
                    }
                    if (this.charts.evolucion) {
                        const resTend = await api.get('/reportes/tendencia');
                        this.aiEnabled = resTend.data.ai_enabled || false;
                        this.charts.evolucion.data.labels = resTend.data.labels;
                        this.charts.evolucion.data.datasets[0].data = resTend.data.historico;
                        this.charts.evolucion.data.datasets[1].data = resTend.data.tendencia;
                        this.charts.evolucion.update();
                        const hC = resTend.data.historico.length;
                        if (resTend.data.tendencia && resTend.data.tendencia.length > hC) this.resumen.proyeccion_30d = resTend.data.tendencia[hC];
                    }
                    if (this.charts.asignacion) {
                        this.charts.asignacion.data.datasets[0].data = [this.resumen.total_liquido, this.resumen.total_activos, this.resumen.total_inversiones];
                        this.charts.asignacion.update();
                    }
                    this.updateWealthChart();
                } catch (e) { console.error('updateCharts fail', e); }
            },

            async updateWealthChart() {
                if (!this.charts.patrimonioHist) return;
                try {
                    const res = await getApiClient().get(`/wealth/history/chart?days=${this.wealthHistoryDays}`);
                    this.charts.patrimonioHist.data.labels = res.data.labels;
                    this.charts.patrimonioHist.data.datasets = res.data.datasets.map(ds => ({
                        ...ds, borderColor: '#00f2ff', backgroundColor: 'rgba(0, 242, 255, 0.1)',
                        fill: true, tension: 0.4, pointRadius: 2, pointHoverRadius: 5
                    }));
                    this.charts.patrimonioHist.update();
                } catch (e) { console.error('updateWealthChart fail', e); }
            }
        }));
    });
</script>
{% endblock %}
