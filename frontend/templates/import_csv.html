{% extends "base.html" %}

{% block title %}Importar CSV - Reconciliación{% endblock %}
{% block header %}Conciliación Bancaria Automática{% endblock %}

{% block content %}
<div x-data="reconciliationWizard" class="container-fluid py-4">
    <div class="row">
        <div class="col-12 col-xl-10 mx-auto">
            
            <!-- Wizard Header -->
            <div class="card bg-dark border-primary mb-4">
                <div class="card-body p-3 d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0 text-primary fw-bold"><i class="fa-solid fa-file-import me-2"></i>WIZARD_DE_IMPORTACION</h5>
                        <small class="text-dim">PASO <span x-text="step"></span> DE 3: <span x-text="stepTitles[step-1]"></span></small>
                    </div>
                </div>
            </div>

            <!-- Step 1: Upload & Account Selection -->
            <div x-show="step === 1" x-transition.opacity>
                <div class="card bg-dark border-secondary">
                    <div class="card-body p-5 text-center">
                        <i class="fa-solid fa-cloud-arrow-up fa-4x mb-4 text-primary opacity-50"></i>
                        <h3 class="mb-4">Seleccione la cuenta y el archivo</h3>
                        
                        <div class="row justify-content-center">
                            <div class="col-md-6">
                                <div class="mb-4 text-start">
                                    <label class="form-label text-dim small">CUENTA_DESTINO</label>
                                    <select x-model="selectedAccount" class="form-select bg-black text-white border-secondary">
                                        <option value="">Seleccione una cuenta...</option>
                                        <template x-for="acc in accounts" :key="acc.id_cuenta">
                                            <option :value="acc.id_cuenta" x-text="acc.nombre_cuenta"></option>
                                        </template>
                                    </select>
                                </div>
                                
                                <div class="mb-4 text-start">
                                    <label class="form-label text-dim small">ARCHIVO_CSV (EXTRACTO)</label>
                                    <input type="file" @change="handleFileUpload" class="form-control bg-black text-white border-secondary" accept=".csv">
                                </div>

                                <button @click="getPreview" :disabled="!selectedAccount || !file" class="btn btn-primary w-100 py-3 fw-bold">
                                    GENERAR_VISTA_PREVIA <i class="fa-solid fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Preview & Matching -->
            <div x-show="step === 2" x-transition.opacity>
                <div class="card bg-dark border-secondary">
                    <div class="card-header bg-black d-flex justify-content-between align-items-center">
                        <span class="text-primary fw-bold">TRANSACCIONES_DETECTADAS (<span x-text="previewData.length"></span>)</span>
                        <button @click="step = 1" class="btn btn-sm btn-outline-secondary">Atrás</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr class="text-dim small">
                                        <th>ESTADO</th>
                                        <th>FECHA</th>
                                        <th>DESCRIPCION</th>
                                        <th class="text-end">MONTO</th>
                                        <th>ACCION</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(tx, index) in previewData" :key="index">
                                        <tr :class="tx.match_id ? 'border-start border-4 border-info' : 'border-start border-4 border-success'">
                                            <td class="align-middle">
                                                <template x-if="tx.match_id">
                                                    <span class="badge bg-info bg-opacity-25 text-info">EXISTENTE (Match 90%)</span>
                                                </template>
                                                <template x-if="!tx.match_id">
                                                    <span class="badge bg-success bg-opacity-25 text-success">NUEVA</span>
                                                </template>
                                            </td>
                                            <td x-text="tx.fecha" class="align-middle fw-bold"></td>
                                            <td class="align-middle">
                                                <div x-text="tx.descripcion"></div>
                                                <template x-if="tx.match_id">
                                                    <small class="text-dim">ID Matched: <span x-text="tx.match_id"></span></small>
                                                </template>
                                            </td>
                                            <td x-text="formatAmount(tx.monto)" class="text-end align-middle fw-bold" :class="tx.monto > 0 ? 'text-success' : 'text-danger'"></td>
                                            <td class="align-middle">
                                                <input type="checkbox" x-model="tx.is_new" :disabled="tx.match_id" class="form-check-input">
                                                <span class="ms-2 small text-dim" x-text="tx.is_new ? 'Importar' : 'Ignorar'"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-black p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-dim small">
                                Total a crear: <span class="text-success fw-bold" x-text="previewData.filter(t => t.is_new).length"></span> | 
                                Matcheadas: <span class="text-info fw-bold" x-text="previewData.filter(t => !t.is_new).length"></span>
                            </div>
                            <button @click="processReconciliation" class="btn btn-success fw-bold">
                                FINALIZAR_CONCILIACION <i class="fa-solid fa-check-double ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Success -->
            <div x-show="step === 3" x-transition.opacity>
                <div class="card bg-dark border-success text-center p-5">
                    <i class="fa-solid fa-circle-check fa-5x text-success mb-4"></i>
                    <h2>¡Conciliación Exitosa!</h2>
                    <p class="text-dim mb-4">Se han procesado las transacciones del extracto bancario.</p>
                    
                    <div class="row justify-content-center">
                        <div class="col-md-4">
                            <div class="p-3 bg-black rounded mb-4">
                                <div class="row">
                                    <div class="col-6 border-end">
                                        <h4 class="text-success mb-0" x-text="stats.created">0</h4>
                                        <small class="text-dim">CREADAS</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-info mb-0" x-text="stats.matched">0</h4>
                                        <small class="text-dim">MATCHED</small>
                                    </div>
                                </div>
                            </div>
                            <a href="/transacciones" class="btn btn-outline-primary w-100">Ver Transacciones</a>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('reconciliationWizard', () => ({
        step: 1,
        stepTitles: ['Configuración', 'Revisión y Matching', 'Completado'],
        accounts: [],
        selectedAccount: '',
        file: null,
        previewData: [],
        stats: {created: 0, matched: 0},
        loading: false,

        async init() {
            // Load accounts for dropdown
            try {
                const res = await api.get('/lista_cuentas/');
                // Handle paginated or direct list
                this.accounts = res.data.data || res.data;
            } catch (e) {
                console.error("Error loading accounts:", e);
            }
        },

        handleFileUpload(e) {
            this.file = e.target.files[0];
        },

        async getPreview() {
            if (!this.file || !this.selectedAccount) return;
            
            this.loading = true;
            const formData = new FormData();
            formData.append('file', this.file);
            formData.append('id_cuenta', this.selectedAccount);

            try {
                const res = await api.post('/reconciliation/preview', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                this.previewData = res.data;
                this.step = 2;
            } catch (e) {
                alert("Error al procesar el archivo: " + (e.response?.data?.detail || e.message));
            } finally {
                this.loading = false;
            }
        },

        async processReconciliation() {
            this.loading = true;
            try {
                const res = await api.post('/reconciliation/process', {
                    id_cuenta: parseInt(this.selectedAccount),
                    transactions: this.previewData
                });
                this.stats = res.data.stats;
                this.step = 3;
            } catch (e) {
                alert("Error al finalizar: " + (e.response?.data?.detail || e.message));
            } finally {
                this.loading = false;
            }
        },

        formatAmount(val) {
            return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(val);
        }
    }));
});
</script>
{% endblock %}
