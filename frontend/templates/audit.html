{% extends "base.html" %}

{% block title %}<span x-text="$store.lang.t('audit.title')">REGISTRO DE SEGURIDAD</span>{% endblock %}

{% block content %}
<div class="container-fluid py-4" x-data="auditManager()">
    <!-- Header de Seguridad -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center bg-black bg-opacity-40 p-4 rounded-4 border border-warning border-opacity-25 shadow-sm overflow-hidden position-relative">
                <div class="scanline opacity-25"></div>
                <div class="d-flex align-items-center position-relative">
                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle me-3 border border-warning border-opacity-20">
                        <i class="fa-solid fa-shield-halved text-warning fs-3 shadow-glow-warning"></i>
                    </div>
                    <div>
                        <h2 class="hud-title text-warning mb-1" x-text="$store.lang.t('audit.title')">REGISTRO DE SEGURIDAD</h2>
                        <p class="text-dim small mb-0 text-uppercase opacity-75" x-text="$store.lang.t('audit.subtitle')">Trazabilidad completa de acciones y cambios en el sistema</p>
                    </div>
                </div>
                <button @click="loadLogs()" class="neon-btn px-4 py-2 shadow-sm border-warning text-warning">
                    <i class="fa-solid fa-sync-alt me-2"></i><span x-text="$store.lang.t('audit.refresh_feed')">Actualizar Feed</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Filtros Rápidos -->
    <div class="row mb-4">
        <div class="col-md-3">
            <label class="text-dim extra-small fw-bold text-uppercase mb-1" x-text="$store.lang.t('audit.col_action')">Acción</label>
            <select class="form-select neon-input extra-small" x-model="filters.accion" @change="loadLogs()">
                <option value="" x-text="$store.lang.t('audit.all_actions')">Todas las acciones</option>
                <option value="CREATE" x-text="$store.lang.t('common.save')">CREACIÓN</option>
                <option value="UPDATE" x-text="$store.lang.t('common.edit')">ACTUALIZACIÓN</option>
                <option value="DELETE" x-text="$store.lang.t('common.delete')">ELIMINACIÓN</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="text-dim extra-small fw-bold text-uppercase mb-1" x-text="$store.lang.t('audit.col_entity')">Entidad</label>
            <select class="form-select neon-input extra-small" x-model="filters.entidad" @change="loadLogs()">
                <option value="" x-text="$store.lang.t('audit.all_entities')">Todas las entidades</option>
                <option value="Transaccion" x-text="$store.lang.t('nav.transactions')">Transacciones</option>
                <option value="Cuenta" x-text="$store.lang.t('nav.accounts')">Cuentas</option>
                <option value="Activo" x-text="$store.lang.t('nav.assets')">Activos</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card neon-card overflow-hidden">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-dark mb-0 align-middle">
                            <thead class="bg-black bg-opacity-40">
                                <tr class="extra-small text-uppercase tracking-wider fw-bold">
                                    <th class="ps-4 py-3 text-primary" x-text="$store.lang.t('audit.col_time')">Fecha y Hora</th>
                                    <th class="py-3 text-primary" x-text="$store.lang.t('audit.col_user')">Usuario</th>
                                    <th class="py-3 text-primary" x-text="$store.lang.t('audit.col_action')">Acción</th>
                                    <th class="py-3 text-primary" x-text="$store.lang.t('audit.col_entity')">Entidad</th>
                                    <th class="py-3 text-primary" x-text="$store.lang.t('audit.col_details')">Detalles</th>
                                    <th class="py-3 text-primary text-end" x-text="$store.lang.t('audit.col_ip')">IP</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="log in logs" :key="log.id_log">
                                    <tr>
                                        <td class="ps-4 text-dim smaller py-3">
                                            <span x-text="formatDate(log.fecha)"></span>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge extra-small bg-secondary bg-opacity-25" x-text="'ID: ' + log.id_usuario"></span>
                                        </td>
                                        <td class="py-3">
                                            <span class="extra-small px-2 py-1 rounded border border-opacity-25" :class="getActionClass(log.accion)" x-text="log.accion"></span>
                                        </td>
                                        <td class="py-3">
                                            <span class="text-white fw-bold" x-text="log.entidad"></span>
                                            <template x-if="log.id_entidad">
                                                <small class="text-dim" x-text="' (ID: ' + log.id_entidad + ')'"></small>
                                            </template>
                                        </td>

                                        <td class="py-3">
                                            <div class="text-wrap extra-small text-dim opacity-75" style="max-width: 300px;" x-text="log.detalles"></div>
                                        </td>
                                        <td class="py-3 text-end ps-4">
                                            <code class="text-info extra-small opacity-50" x-text="log.ip_address || 'N/A'"></code>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <template x-if="logs.length === 0">
                        <div class="text-center py-5">
                            <i class="fa-solid fa-ghost fs-1 text-dim opacity-25 mb-3"></i>
                            <p class="text-dim">No hay registros de actividad que coincidan con los filtros.</p>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .shadow-glow-warning { text-shadow: 0 0 15px rgba(255, 193, 7, 0.6); }
</style>

<script>
    function auditManager() {
        return {
            logs: [],
            filters: {
                accion: '',
                entidad: ''
            },
            
            init() {
                this.loadLogs();
            },
            
            async loadLogs() {
                try {
                    const params = new URLSearchParams();
                    if (this.filters.accion) params.append('accion', this.filters.accion);
                    if (this.filters.entidad) params.append('entidad', this.filters.entidad);
                    
                    const res = await api.get('/audit/logs?' + params.toString());
                    this.logs = res.data;
                } catch (e) {
                    notifications.error('Error al cargar logs de auditoría');
                }
            },
            
            formatDate(iso) {
                return new Date(iso).toLocaleString('es-AR', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
            },
            
            getActionClass(accion) {
                switch(accion) {
                    case 'CREATE': return 'border-success text-success';
                    case 'UPDATE': return 'border-info text-info';
                    case 'DELETE': return 'border-danger text-danger';
                    default: return 'border-secondary text-dim';
                }
            }
        }
    }
</script>
{% endblock %}
