{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4" x-data="auditManager()">
    <!-- Header de Seguridad -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center bg-dark bg-opacity-50 p-4 rounded-4 border border-warning border-opacity-25 shadow-lg">
                <div class="d-flex align-items-center">
                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle me-3 border border-warning border-opacity-50">
                        <i class="fa-solid fa-shield-halved text-warning fs-3 shadow-glow-warning"></i>
                    </div>
                    <div>
                        <h2 class="Orbitron text-white mb-1">REGISTRO DE SEGURIDAD</h2>
                        <p class="text-dim small mb-0">Trazabilidad completa de acciones y cambios en el sistema</p>
                    </div>
                </div>
                <button @click="loadLogs()" class="btn btn-outline-warning rounded-pill px-4">
                    <i class="fa-solid fa-rotate me-2"></i>Actualizar Feed
                </button>
            </div>
        </div>
    </div>

    <!-- Filtros Rápidos -->
    <div class="row mb-4">
        <div class="col-md-3">
            <label class="text-dim smaller mb-1">Acción</label>
            <select class="form-select bg-dark border-secondary text-white" x-model="filters.accion" @change="loadLogs()">
                <option value="">Todas las acciones</option>
                <option value="CREATE">CREACIÓN</option>
                <option value="UPDATE">ACTUALIZACIÓN</option>
                <option value="DELETE">ELIMINACIÓN</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="text-dim smaller mb-1">Entidad</label>
            <select class="form-select bg-dark border-secondary text-white" x-model="filters.entidad" @change="loadLogs()">
                <option value="">Todas las entidades</option>
                <option value="Transaccion">Transacciones</option>
                <option value="Cuenta">Cuentas</option>
                <option value="Activo">Activos</option>
            </select>
        </div>
    </div>

    <!-- Tabla de Auditoría -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark border-secondary shadow-lg">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0 align-middle">
                            <thead class="bg-black bg-opacity-50">
                                <tr>
                                    <th class="ps-4 py-3 border-secondary">Fecha y Hora</th>
                                    <th class="py-3 border-secondary">Usuario</th>
                                    <th class="py-3 border-secondary">Acción</th>
                                    <th class="py-3 border-secondary">Entidad</th>
                                    <th class="py-3 border-secondary">Detalles</th>
                                    <th class="py-3 border-secondary">IP</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="log in logs" :key="log.id_log">
                                    <tr>
                                        <td class="ps-4 text-dim smaller py-3">
                                            <span x-text="formatDate(log.fecha)"></span>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-secondary opacity-75" x-text="'ID: ' + log.id_usuario"></span>
                                        </td>
                                        <td class="py-3">
                                            <span :class="getActionClass(log.accion)" x-text="log.accion"></span>
                                        </td>
                                        <td class="py-3">
                                            <span class="text-white fw-bold" x-text="log.entidad"></span>
                                            <small class="text-dim" x-if="log.id_entidad" x-text="' (ID: ' + log.id_entidad + ')'"></small>
                                        </td>
                                        <td class="py-3">
                                            <div class="text-wrap smaller text-dim" style="max-width: 300px;" x-text="log.detalles"></div>
                                        </td>
                                        <td class="py-3">
                                            <code class="text-info smaller" x-text="log.ip_address || 'N/A'"></code>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <template x-if="logs.length === 0">
                        <div class="text-center py-5">
                            <i class="fa-solid fa-ghost fs-1 text-dim opacity-25 mb-3"></i>
                            <p class="text-dim">No hay registros de actividad que coincidan con los filtros.</p>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .shadow-glow-warning { text-shadow: 0 0 10px rgba(255, 193, 7, 0.4); }
    .smaller { font-size: 0.8rem; }
</style>

<script>
    function auditManager() {
        return {
            logs: [],
            filters: {
                accion: '',
                entidad: ''
            },
            
            init() {
                this.loadLogs();
            },
            
            async loadLogs() {
                try {
                    const params = new URLSearchParams();
                    if (this.filters.accion) params.append('accion', this.filters.accion);
                    if (this.filters.entidad) params.append('entidad', this.filters.entidad);
                    
                    const res = await api.get('/audit/logs?' + params.toString());
                    this.logs = res.data;
                } catch (e) {
                    notifications.error('Error al cargar logs de auditoría');
                }
            },
            
            formatDate(iso) {
                return new Date(iso).toLocaleString('es-AR', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
            },
            
            getActionClass(accion) {
                switch(accion) {
                    case 'CREATE': return 'badge bg-success bg-opacity-25 text-success border border-success border-opacity-50';
                    case 'UPDATE': return 'badge bg-info bg-opacity-25 text-info border border-info border-opacity-50';
                    case 'DELETE': return 'badge bg-danger bg-opacity-25 text-danger border border-danger border-opacity-50';
                    default: return 'badge bg-secondary';
                }
            }
        }
    }
</script>
{% endblock %}
