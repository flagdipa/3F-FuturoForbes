{% extends "base.html" %}
{% block content %}
<div class="step-container">
    <h2>ConfiguraciÃ³n de Base de Datos</h2>
    <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 24px;">
        Ingresa las credenciales de tu servidor de base de datos.
    </p>

    <div class="alert alert-info">
        <strong>ðŸ’¡ Tip para Docker/VPS:</strong> 
        Si usas Dokploy, usa el <b>Internal Host</b> (ej: <code>db</code> o <code>f3-3f-xxx</code>) en lugar de <code>localhost</code>.
    </div>

    <form onsubmit="testConnection(event)">
        <div class="form-group">
            <label>Motor de Base de Datos</label>
            <select id="db_type" class="form-control">
                <option value="mysql">MySQL / MariaDB</option>
                <option value="postgresql">PostgreSQL</option>
            </select>
        </div>

        <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 16px;">
            <div class="form-group">
                <label>Host</label>
                <input type="text" id="host" class="form-control" value="localhost" placeholder="ej: db o f3-3f-t48idh">
            </div>
            <div class="form-group">
                <label>Puerto</label>
                <input type="number" id="port" class="form-control" value="3306">
            </div>
        </div>

        <div class="form-group">
            <label>Usuario</label>
            <input type="text" id="user" class="form-control" value="root">
        </div>

        <div class="form-group">
            <label>ContraseÃ±a</label>
            <input type="password" id="pass" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>

        <div class="form-group">
            <label>Nombre de la Base de Datos</label>
            <input type="text" id="db" class="form-control" value="futuroforbes">
        </div>

        <div class="form-group" style="margin-top: 10px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="create_db" checked style="margin-right: 8px;">
                Crear base de datos si no existe
            </label>
        </div>

        <button type="submit" class="btn btn-outline" style="width: 100%; margin-top: 10px;" id="btn-test">
            ðŸ§ª Probar ConexiÃ³n
        </button>
    </form>

    <div class="action-buttons">
        <button class="btn btn-secondary" onclick="location.href='/install/step/2'">AtrÃ¡s</button>
        <button id="btn-next" class="btn btn-primary" style="visibility: hidden" onclick="location.href='/install/step/4'">Continuar</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function testConnection(e) {
    e.preventDefault();
    const btn = document.getElementById('btn-test');
    const nextBtn = document.getElementById('btn-next');
    
    btn.disabled = true;
    btn.innerText = 'âŒ› Conectando...';

    const body = {
        db_type: document.getElementById('db_type').value,
        host: document.getElementById('host').value,
        port: parseInt(document.getElementById('port').value),
        user: document.getElementById('user').value,
        password: document.getElementById('pass').value,
        database: document.getElementById('db').value,
        create_if_not_exists: document.getElementById('create_db').checked
    };

    try {
        const res = await fetch('/install/api/test-database', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        });
        const data = await res.json();

        if (data.success) {
            localStorage.setItem('dbConfig', JSON.stringify(body));
            nextBtn.style.visibility = 'visible';
            alert('âœ… Â¡ConexiÃ³n exitosa!');
            btn.innerText = 'ðŸ§ª Probar de nuevo';
            btn.classList.add('alert-success');
        } else {
            alert('âŒ Error: ' + data.message);
            btn.innerText = 'ðŸ§ª Reintentar';
        }
    } catch (error) {
        alert('âŒ Error de red: ' + error.message);
        btn.innerText = 'ðŸ§ª Probar ConexiÃ³n';
    } finally {
        btn.disabled = false;
    }
}

// Auto-ajustar puerto segÃºn motor
document.getElementById('db_type').addEventListener('change', (e) => {
    document.getElementById('port').value = e.target.value === 'mysql' ? 3306 : 5432;
});
</script>
{% endblock %}
